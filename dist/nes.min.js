var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])};return function(i,e){function s(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)}}();!function(t){if("object"==typeof module&&"object"==typeof module.exports){var i=t(require,exports);void 0!==i&&(module.exports=i)}else"function"==typeof define&&define.amd&&define(["require","exports"],t)}(function(t,i){"use strict";function e(t,i){t.turbo[i]?t.firing[i]?t.state[i]=t.state[i]===d.down?d.up:d.down:(t.firing[i]=!0,t.state[i]=d.down):t.firing[i]&&(t.firing[i]=!1,t.state[i]=d.up)}function s(t,i,e,s,r){for(var h=0;h<r;h+=1)e[s+h]=t[i+h]}Object.defineProperty(i,"__esModule",{value:!0});var r,h=60,a=1789772.5,n=function(){function t(t,i){this.cpu=t,this.onAudioSample=i,this.square1=new p(this,!0),this.square2=new p(this,!1),this.triangle=new u(this),this.noise=new l(this),this.dmc=new o(this),this.frameIrqCounterMax=4,this.initCounter=2048,this.sampleRate=44100,this.lengthLookup=null,this.dmcFreqLookup=null,this.noiseWavelengthLookup=null,this.square_table=null,this.tnd_table=null,this.frameIrqEnabled=!1,this.frameIrqActive=!1,this.startedPlaying=!1,this.recordOutput=!1,this.initingHardware=!1,this.masterFrameCounter=0,this.derivedFrameCounter=0,this.countSequence=0,this.sampleTimer=0,this.frameTime=Math.floor(14915*h/60),this.sampleTimerMax=Math.floor(1024*a*h/(60*this.sampleRate)),this.sampleCount=0,this.triValue=0,this.accCount=0,this.smpSquare1=0,this.smpSquare2=0,this.smpTriangle=0,this.smpDmc=0,this.prevSample=0,this.smpAccum=0,this.dacRange=0,this.dcValue=0,this.masterVolume=256,this.posSquare1=null,this.posSquare2=null,this.posTriangle=null,this.posNoise=null,this.posDMC=null,this.extraCycles=null,this.maxSample=-5e5,this.minSample=5e5,this.panning=[80,170,100,150,128],this.setPanning(this.panning),this.initLengthLookup(),this.initDmcFrequencyLookup(),this.initNoiseWavelengthLookup(),this.initDACtables();for(var e=0;e<20;e++)16===e?this.writeReg(16400,16):this.writeReg(16384+e,0);this.updateChannelEnable(0)}return t.prototype.readReg=function(t){var i=0;return i|=this.square1.getLengthStatus(),i|=this.square2.getLengthStatus()<<1,i|=this.triangle.getLengthStatus()<<2,i|=this.noise.getLengthStatus()<<3,i|=this.dmc.getLengthStatus()<<4,i|=(this.frameIrqActive&&this.frameIrqEnabled?1:0)<<6,i|=this.dmc.getIrqStatus()<<7,this.frameIrqActive=!1,this.dmc.irqGenerated=!1,65535&i},t.prototype.writeReg=function(t,i){t>=16384&&t<16388?this.square1.writeReg(t,i):t>=16388&&t<16392?this.square2.writeReg(t,i):t>=16392&&t<16396?this.triangle.writeReg(t,i):t>=16396&&t<=16399?this.noise.writeReg(t,i):16400===t?this.dmc.writeReg(t,i):16401===t?this.dmc.writeReg(t,i):16402===t?this.dmc.writeReg(t,i):16403===t?this.dmc.writeReg(t,i):16405===t?(this.updateChannelEnable(i),0!==i&&this.initCounter>0&&(this.initingHardware=!0),this.dmc.writeReg(t,i)):16407===t&&(this.countSequence=i>>7&1,this.masterFrameCounter=0,this.frameIrqActive=!1,this.frameIrqEnabled=0==(i>>6&1),0===this.countSequence?(this.frameIrqCounterMax=4,this.derivedFrameCounter=4):(this.frameIrqCounterMax=5,this.derivedFrameCounter=0,this.frameCounterTick()))},t.prototype.updateChannelEnable=function(t){this.channelEnableValue=65535&t,this.square1.setEnabled(0!=(1&t)),this.square2.setEnabled(0!=(2&t)),this.triangle.setEnabled(0!=(4&t)),this.noise.setEnabled(0!=(8&t)),this.dmc.setEnabled(0!=(16&t))},t.prototype.clockFrameCounter=function(t){if(this.initCounter>0&&this.initingHardware)return this.initCounter-=t,void(this.initCounter<=0&&(this.initingHardware=!1));t+=this.extraCycles;var i=this.sampleTimerMax-this.sampleTimer;t<<10>i?(this.extraCycles=(t<<10)-i>>10,t-=this.extraCycles):this.extraCycles=0;var e=this.dmc,s=this.triangle,r=this.square1,h=this.square2,a=this.noise;if(e.isEnabled)for(e.shiftCounter-=t<<3;e.shiftCounter<=0&&e.dmaFrequency>0;)e.shiftCounter+=e.dmaFrequency,e.clockDmc();if(s.progTimerMax>0)for(s.progTimerCount-=t;s.progTimerCount<=0;)s.progTimerCount+=s.progTimerMax+1,s.linearCounter>0&&s.lengthCounter>0&&(s.triangleCounter++,s.triangleCounter&=31,s.isEnabled&&(s.triangleCounter>=16?s.sampleValue=15&s.triangleCounter:s.sampleValue=15-(15&s.triangleCounter),s.sampleValue<<=4));r.progTimerCount-=t,r.progTimerCount<=0&&(r.progTimerCount+=r.progTimerMax+1<<1,r.squareCounter++,r.squareCounter&=7,r.updateSampleValue()),h.progTimerCount-=t,h.progTimerCount<=0&&(h.progTimerCount+=h.progTimerMax+1<<1,h.squareCounter++,h.squareCounter&=7,h.updateSampleValue());var n=t;if(a.progTimerCount-n>0)a.progTimerCount-=n,a.accCount+=n,a.accValue+=n*a.sampleValue;else for(;n-- >0;)--a.progTimerCount<=0&&a.progTimerMax>0&&(a.shiftReg<<=1,a.tmp=32768&(a.shiftReg<<(0===a.randomMode?1:6)^a.shiftReg),0!==a.tmp?(a.shiftReg|=1,a.randomBit=0,a.sampleValue=0):(a.randomBit=1,a.isEnabled&&a.lengthCounter>0?a.sampleValue=a.masterVolume:a.sampleValue=0),a.progTimerCount+=a.progTimerMax),a.accValue+=a.sampleValue,a.accCount++;this.frameIrqEnabled&&this.frameIrqActive&&this.cpu.requestIrq(g.NORMAL),this.masterFrameCounter+=t<<1,this.masterFrameCounter>=this.frameTime&&(this.masterFrameCounter-=this.frameTime,this.frameCounterTick()),this.accSample(t),this.sampleTimer+=t<<10,this.sampleTimer>=this.sampleTimerMax&&(this.sample(),this.sampleTimer-=this.sampleTimerMax)},t.prototype.accSample=function(t){this.triangle.sampleCondition&&(this.triValue=Math.floor((this.triangle.progTimerCount<<4)/(this.triangle.progTimerMax+1)),this.triValue>16&&(this.triValue=16),this.triangle.triangleCounter>=16&&(this.triValue=16-this.triValue),this.triValue+=this.triangle.sampleValue),2===t?(this.smpTriangle+=this.triValue<<1,this.smpDmc+=this.dmc.sample<<1,this.smpSquare1+=this.square1.sampleValue<<1,this.smpSquare2+=this.square2.sampleValue<<1,this.accCount+=2):4===t?(this.smpTriangle+=this.triValue<<2,this.smpDmc+=this.dmc.sample<<2,this.smpSquare1+=this.square1.sampleValue<<2,this.smpSquare2+=this.square2.sampleValue<<2,this.accCount+=4):(this.smpTriangle+=t*this.triValue,this.smpDmc+=t*this.dmc.sample,this.smpSquare1+=t*this.square1.sampleValue,this.smpSquare2+=t*this.square2.sampleValue,this.accCount+=t)},t.prototype.frameCounterTick=function(){this.derivedFrameCounter++,this.derivedFrameCounter>=this.frameIrqCounterMax&&(this.derivedFrameCounter=0),1!==this.derivedFrameCounter&&3!==this.derivedFrameCounter||(this.triangle.clockLengthCounter(),this.square1.clockLengthCounter(),this.square2.clockLengthCounter(),this.noise.clockLengthCounter(),this.square1.clockSweep(),this.square2.clockSweep()),this.derivedFrameCounter>=0&&this.derivedFrameCounter<4&&(this.square1.clockEnvDecay(),this.square2.clockEnvDecay(),this.noise.clockEnvDecay(),this.triangle.clockLinearCounter()),3===this.derivedFrameCounter&&0===this.countSequence&&(this.frameIrqActive=!0)},t.prototype.sample=function(){var t,i;this.accCount>0?(this.smpSquare1<<=4,this.smpSquare1=Math.floor(this.smpSquare1/this.accCount),this.smpSquare2<<=4,this.smpSquare2=Math.floor(this.smpSquare2/this.accCount),this.smpTriangle=Math.floor(this.smpTriangle/this.accCount),this.smpDmc<<=4,this.smpDmc=Math.floor(this.smpDmc/this.accCount),this.accCount=0):(this.smpSquare1=this.square1.sampleValue<<4,this.smpSquare2=this.square2.sampleValue<<4,this.smpTriangle=this.triangle.sampleValue,this.smpDmc=this.dmc.sample<<4);var e=Math.floor((this.noise.accValue<<4)/this.noise.accCount);this.noise.accValue=e>>4,this.noise.accCount=1,t=this.smpSquare1*this.posSquare1+this.smpSquare2*this.posSquare2>>8,i=3*this.smpTriangle*this.posTriangle+(e<<1)*this.posNoise+this.smpDmc*this.posDMC>>8,t>=this.square_table.length&&(t=this.square_table.length-1),i>=this.tnd_table.length&&(i=this.tnd_table.length-1);var s=this.square_table[t]+this.tnd_table[i]-this.dcValue,r=s-this.prevSample;this.prevSample+=r,this.smpAccum+=r-(this.smpAccum>>10),s=this.smpAccum,s>this.maxSample&&(this.maxSample=s),s<this.minSample&&(this.minSample=s),this.onAudioSample(s/32768),this.smpSquare1=0,this.smpSquare2=0,this.smpTriangle=0,this.smpDmc=0},t.prototype.getLengthMax=function(t){return this.lengthLookup[t>>3]},t.prototype.getDmcFrequency=function(t){return t>=0&&t<16?this.dmcFreqLookup[t]:0},t.prototype.getNoiseWaveLength=function(t){return t>=0&&t<16?this.noiseWavelengthLookup[t]:0},t.prototype.setPanning=function(t){for(var i=0;i<5;i++)this.panning[i]=t[i];this.updateStereoPos()},t.prototype.setMasterVolume=function(t){t<0&&(t=0),t>256&&(t=256),this.masterVolume=t,this.updateStereoPos()},t.prototype.updateStereoPos=function(){this.posSquare1=this.panning[0]*this.masterVolume>>8,this.posSquare2=this.panning[1]*this.masterVolume>>8,this.posTriangle=this.panning[2]*this.masterVolume>>8,this.posNoise=this.panning[3]*this.masterVolume>>8,this.posDMC=this.panning[4]*this.masterVolume>>8},t.prototype.initLengthLookup=function(){this.lengthLookup=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30]},t.prototype.initDmcFrequencyLookup=function(){this.dmcFreqLookup=new Array(16),this.dmcFreqLookup[0]=3424,this.dmcFreqLookup[1]=3040,this.dmcFreqLookup[2]=2720,this.dmcFreqLookup[3]=2560,this.dmcFreqLookup[4]=2288,this.dmcFreqLookup[5]=2032,this.dmcFreqLookup[6]=1808,this.dmcFreqLookup[7]=1712,this.dmcFreqLookup[8]=1520,this.dmcFreqLookup[9]=1280,this.dmcFreqLookup[10]=1136,this.dmcFreqLookup[11]=1024,this.dmcFreqLookup[12]=848,this.dmcFreqLookup[13]=672,this.dmcFreqLookup[14]=576,this.dmcFreqLookup[15]=432},t.prototype.initNoiseWavelengthLookup=function(){this.noiseWavelengthLookup=new Array(16),this.noiseWavelengthLookup[0]=4,this.noiseWavelengthLookup[1]=8,this.noiseWavelengthLookup[2]=16,this.noiseWavelengthLookup[3]=32,this.noiseWavelengthLookup[4]=64,this.noiseWavelengthLookup[5]=96,this.noiseWavelengthLookup[6]=128,this.noiseWavelengthLookup[7]=160,this.noiseWavelengthLookup[8]=202,this.noiseWavelengthLookup[9]=254,this.noiseWavelengthLookup[10]=380,this.noiseWavelengthLookup[11]=508,this.noiseWavelengthLookup[12]=762,this.noiseWavelengthLookup[13]=1016,this.noiseWavelengthLookup[14]=2034,this.noiseWavelengthLookup[15]=4068},t.prototype.initDACtables=function(){var t,i,e,s=0,r=0;for(this.square_table=new Array(512),this.tnd_table=new Array(3264),e=0;e<512;e++)t=95.52/(8128/(e/16)+100),t*=.98411,t*=5e4,i=Math.floor(t),this.square_table[e]=i,i>s&&(s=i);for(e=0;e<3264;e++)t=163.67/(24329/(e/16)+100),t*=.98411,t*=5e4,i=Math.floor(t),this.tnd_table[e]=i,i>r&&(r=i);this.dacRange=s+r,this.dcValue=this.dacRange/2},t}();!function(t){t[t.NORMAL=0]="NORMAL",t[t.LOOP=1]="LOOP",t[t.IRQ=2]="IRQ"}(r||(r={}));var o=function(){function t(t){this.apu=t,this.isEnabled=!1,this.hasSample=!1,this.irqGenerated=!1,this.playMode=r.NORMAL,this.dmaFrequency=0,this.dmaCounter=0,this.deltaCounter=0,this.playStartAddress=0,this.playAddress=0,this.playLength=0,this.playLengthCounter=0,this.sample=0,this.dacLsb=0,this.shiftCounter=0,this.reg4012=0,this.reg4013=0,this.data=0}return t.prototype.clockDmc=function(){this.hasSample&&(0==(1&this.data)?this.deltaCounter>0&&this.deltaCounter--:this.deltaCounter<63&&this.deltaCounter++,this.sample=this.isEnabled?(this.deltaCounter<<1)+this.dacLsb:0,this.data>>=1),this.dmaCounter--,this.dmaCounter<=0&&(this.hasSample=!1,this.endOfSample(),this.dmaCounter=8),this.irqGenerated&&this.apu.cpu.requestIrq(g.NORMAL)},t.prototype.endOfSample=function(){0===this.playLengthCounter&&this.playMode===r.LOOP&&(this.playAddress=this.playStartAddress,this.playLengthCounter=this.playLength),this.playLengthCounter>0&&(this.nextSample(),0===this.playLengthCounter&&this.playMode===r.IRQ&&(this.irqGenerated=!0))},t.prototype.nextSample=function(){this.data=this.apu.cpu.mapper.load(this.playAddress),this.apu.cpu.haltCycles(4),this.playLengthCounter--,this.playAddress++,this.playAddress>65535&&(this.playAddress=32768),this.hasSample=!0},t.prototype.writeReg=function(t,i){16400===t?(i>>6==0?this.playMode=r.NORMAL:1==(i>>6&1)?this.playMode=r.LOOP:i>>6==2&&(this.playMode=r.IRQ),0==(128&i)&&(this.irqGenerated=!1),this.dmaFrequency=this.apu.getDmcFrequency(15&i)):16401===t?(this.deltaCounter=i>>1&63,this.dacLsb=1&i,this.sample=(this.deltaCounter<<1)+this.dacLsb):16402===t?(this.playStartAddress=i<<6|49152,this.playAddress=this.playStartAddress,this.reg4012=i):16403===t?(this.playLength=1+(i<<4),this.playLengthCounter=this.playLength,this.reg4013=i):16405===t&&(0==(i>>4&1)?this.playLengthCounter=0:(this.playAddress=this.playStartAddress,this.playLengthCounter=this.playLength),this.irqGenerated=!1)},t.prototype.setEnabled=function(t){!this.isEnabled&&t&&(this.playLengthCounter=this.playLength),this.isEnabled=t},t.prototype.getLengthStatus=function(){return 0!==this.playLengthCounter&&this.isEnabled?1:0},t.prototype.getIrqStatus=function(){return this.irqGenerated?1:0},t}(),l=function(){function t(t){this.apu=t,this.progTimerCount=0,this.progTimerMax=0,this.isEnabled=!1,this.lengthCounter=0,this.lengthCounterEnable=!1,this.envReset=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1,this.shiftNow=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.shiftReg=1,this.randomBit=0,this.randomMode=0,this.sampleValue=0,this.accValue=0,this.accCount=1,this.tmp=0}return t.prototype.clockLengthCounter=function(){this.lengthCounterEnable&&this.lengthCounter>0&&0===--this.lengthCounter&&this.updateSampleValue()},t.prototype.clockEnvDecay=function(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume--:this.envVolume=this.envDecayLoopEnable?15:0),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateSampleValue()},t.prototype.updateSampleValue=function(){this.isEnabled&&this.lengthCounter>0&&(this.sampleValue=this.randomBit*this.masterVolume)},t.prototype.writeReg=function(t,i){16396===t?(this.envDecayDisable=0!=(16&i),this.envDecayRate=15&i,this.envDecayLoopEnable=0!=(32&i),this.lengthCounterEnable=0==(32&i),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume):16398===t?(this.progTimerMax=this.apu.getNoiseWaveLength(15&i),this.randomMode=i>>7):16399===t&&(this.lengthCounter=this.apu.getLengthMax(248&i),this.envReset=!0)},t.prototype.setEnabled=function(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateSampleValue()},t.prototype.getLengthStatus=function(){return 0!==this.lengthCounter&&this.isEnabled?1:0},t}(),p=function(){function t(t,i){this.apu=t,this.sqr1=i,this.dutyLookup=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1],this.impLookup=[1,-1,0,0,0,0,0,0,1,0,-1,0,0,0,0,0,1,0,0,0,-1,0,0,0,-1,0,1,0,0,0,0,0],this.progTimerCount=0,this.progTimerMax=0,this.lengthCounter=0,this.squareCounter=0,this.sweepCounter=0,this.sweepCounterMax=0,this.sweepMode=0,this.sweepShiftAmount=0,this.envReset=!1,this.envDecayRate=0,this.envDecayCounter=0,this.envVolume=0,this.masterVolume=0,this.dutyMode=0,this.vol=0,this.isEnabled=!1,this.lengthCounterEnable=!1,this.sweepActive=!1,this.sweepCarry=!1,this.updateSweepPeriod=!1,this.envDecayDisable=!1,this.envDecayLoopEnable=!1}return t.prototype.clockLengthCounter=function(){this.lengthCounterEnable&&this.lengthCounter>0&&(this.lengthCounter-=1,0===this.lengthCounter&&this.updateSampleValue())},t.prototype.clockEnvDecay=function(){this.envReset?(this.envReset=!1,this.envDecayCounter=this.envDecayRate+1,this.envVolume=15):--this.envDecayCounter<=0&&(this.envDecayCounter=this.envDecayRate+1,this.envVolume>0?this.envVolume-=1:this.envVolume=this.envDecayLoopEnable?15:0),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateSampleValue()},t.prototype.clockSweep=function(){this.sweepCounter-=1,this.sweepCounter<=0&&(this.sweepCounter=this.sweepCounterMax+1,this.sweepActive&&this.sweepShiftAmount>0&&this.progTimerMax>7&&(this.sweepCarry=!1,0===this.sweepMode?(this.progTimerMax+=this.progTimerMax>>this.sweepShiftAmount,this.progTimerMax>4095&&(this.progTimerMax=4095,this.sweepCarry=!0)):this.progTimerMax=this.progTimerMax-((this.progTimerMax>>this.sweepShiftAmount)-(this.sqr1?1:0)))),this.updateSweepPeriod&&(this.updateSweepPeriod=!1,this.sweepCounter=this.sweepCounterMax+1)},t.prototype.updateSampleValue=function(){this.isEnabled&&this.lengthCounter>0&&this.progTimerMax>7?0===this.sweepMode&&this.progTimerMax+(this.progTimerMax>>this.sweepShiftAmount)>4095?this.sampleValue=0:this.sampleValue=this.masterVolume*this.dutyLookup[(this.dutyMode<<3)+this.squareCounter]:this.sampleValue=0},t.prototype.writeReg=function(t,i){var e=this.sqr1?0:4;t===16384+e?(this.envDecayDisable=0!=(16&i),this.envDecayRate=15&i,this.envDecayLoopEnable=0!=(32&i),this.dutyMode=i>>6&3,this.lengthCounterEnable=0==(32&i),this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume,this.updateSampleValue()):t===16385+e?(this.sweepActive=0!=(128&i),this.sweepCounterMax=i>>4&7,this.sweepMode=i>>3&1,this.sweepShiftAmount=7&i,this.updateSweepPeriod=!0):t===16386+e?(this.progTimerMax&=1792,this.progTimerMax|=i):t===16387+e&&(this.progTimerMax&=255,this.progTimerMax|=(7&i)<<8,this.isEnabled&&(this.lengthCounter=this.apu.getLengthMax(248&i)),this.envReset=!0)},t.prototype.setEnabled=function(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateSampleValue()},t.prototype.getLengthStatus=function(){return 0!==this.lengthCounter&&this.isEnabled?1:0},t}(),u=function(){function t(t){this.apu=t,this.progTimerCount=0,this.progTimerMax=0,this.triangleCounter=0,this.isEnabled=!1,this.sampleCondition=!1,this.lengthCounter=0,this.lengthCounterEnable=!1,this.linearCounter=0,this.lcLoadValue=0,this.lcHalt=!0,this.lcControl=!1,this.tmp=0,this.sampleValue=15}return t.prototype.clockLengthCounter=function(){this.lengthCounterEnable&&this.lengthCounter>0&&(this.lengthCounter-=1,0===this.lengthCounter&&this.updateSampleCondition())},t.prototype.clockLinearCounter=function(){this.lcHalt?(this.linearCounter=this.lcLoadValue,this.updateSampleCondition()):this.linearCounter>0&&(this.linearCounter-=1,this.updateSampleCondition()),this.lcControl||(this.lcHalt=!1)},t.prototype.getLengthStatus=function(){return 0!==this.lengthCounter&&this.isEnabled?1:0},t.prototype.readReg=function(t){return 0},t.prototype.writeReg=function(t,i){16392===t?(this.lcControl=0!=(128&i),this.lcLoadValue=127&i,this.lengthCounterEnable=!this.lcControl):16394===t?(this.progTimerMax&=1792,this.progTimerMax|=i):16395===t&&(this.progTimerMax&=255,this.progTimerMax|=(7&i)<<8,this.lengthCounter=this.apu.getLengthMax(248&i),this.lcHalt=!0),this.updateSampleCondition()},t.prototype.clockProgrammableTimer=function(t){if(this.progTimerMax>0)for(this.progTimerCount+=t;this.progTimerMax>0&&this.progTimerCount>=this.progTimerMax;)this.progTimerCount-=this.progTimerMax,this.isEnabled&&this.lengthCounter>0&&this.linearCounter>0&&this.clockTriangleGenerator()},t.prototype.clockTriangleGenerator=function(){this.triangleCounter+=1,this.triangleCounter&=31},t.prototype.setEnabled=function(t){this.isEnabled=t,t||(this.lengthCounter=0),this.updateSampleCondition()},t.prototype.updateSampleCondition=function(){this.sampleCondition=this.isEnabled&&this.progTimerMax>7&&this.linearCounter>0&&this.lengthCounter>0},t}(),c=function(){function t(){this.buffer=[]}return t.prototype.close=function(){this.processor&&(this.processor.disconnect(this.context.destination),this.processor=null),this.context&&(this.context.close(),this.context=null)},t.prototype.push=function(t){if(this.proccessorReady())for(var i=Array.isArray(t)?t:[t],e=0;e<i.length;e+=1)this.buffer.push(i[e])},t.prototype.play=function(t){if(this.contextReady()){for(var i=this.context.createBuffer(1,t.length,this.context.sampleRate),e=i.getChannelData(0),s=0;s<t.length;s+=1)e[s]=t[s];var r=this.context.createBufferSource();r.buffer=i,r.connect(this.context.destination),r.start()}},t.prototype.onaudioprocess=function(t){var i=t.outputBuffer.getChannelData(0);for(this.onbufferunderrun&&this.buffer.length<i.length&&this.onbufferunderrun(this.buffer.length,i.length);this.buffer.length>2*i.length;)this.buffer=this.buffer.slice(i.length);for(var e=Math.min(this.buffer.length,i.length),s=0;s<e;s++)i[s]=this.buffer[s];this.buffer=this.buffer.slice(e)},t.prototype.contextReady=function(){if(this.context)return!0;if(window){var t=window.AudioContext||window.webkitAudioContext;return!!t&&(this.context=new t,!0)}return!1},t.prototype.proccessorReady=function(){return!!this.processor||!!this.contextReady()&&(this.buffer=[],this.processor=this.context.createScriptProcessor(1024,1,1),this.processor.onaudioprocess=this.onaudioprocess.bind(this),this.processor.connect(this.context.destination),void 0)},t}();i.Speaker=c;var m;!function(t){t[t.a=0]="a",t[t.b=1]="b",t[t.select=2]="select",t[t.start=3]="start",t[t.up=4]="up",t[t.down=5]="down",t[t.left=6]="left",t[t.right=7]="right"}(m||(m={}));var d;!function(t){t[t.down=65]="down",t[t.up=64]="up"}(d||(d={}));var g,R=function(){function t(){this.tickedOn=0,this.p1={state:[],turbo:{},firing:{}},this.p2={state:[],turbo:{},firing:{}},this.buttonMaps={a:{key:m.a,turbo:!1},A:{key:m.a,turbo:!0},b:{key:m.b,turbo:!1},B:{key:m.b,turbo:!0},select:{key:m.select,turbo:!1},start:{key:m.start,turbo:!1},u:{key:m.up,turbo:!1},d:{key:m.down,turbo:!1},l:{key:m.left,turbo:!1},r:{key:m.right,turbo:!1}};for(var t=0;t<8;t+=1)this.state1[t]=d.up,this.state1[t]=d.up,this.p1.turbo[t]=!1,this.p2.firing[t]=!1}return Object.defineProperty(t.prototype,"state1",{get:function(){return this.p1.state},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state2",{get:function(){return this.p2.state},enumerable:!0,configurable:!0}),t.prototype.frame=function(){var t=Date.now();if(t-this.tickedOn>50){for(var i=0;i<8;i+=1)e(this.p1,i),e(this.p2,i);this.tickedOn=t}},t.prototype.buttonDown=function(t,i){var e=this.buttonMaps[i];e&&(1===t?e.turbo?this.p1.turbo[e.key]=!0:this.p1.state[e.key]=d.down:2===t&&(e.turbo?this.p2.turbo[e.key]=!0:this.p2.state[e.key]=d.down))},t.prototype.buttonUp=function(t,i){var e=this.buttonMaps[i];e&&(1===t?e.turbo?this.p1.turbo[e.key]=!1:this.p1.state[e.key]=d.up:2===t&&(e.turbo?this.p2.turbo[e.key]=!1:this.p2.state[e.key]=d.up))},t}();!function(t){t[t.NORMAL=0]="NORMAL",t[t.NMI=1]="NMI",t[t.RESET=2]="RESET"}(g||(g={}));var f,b=function(){function t(t){this.mapper=t,this.mem=new Array(65536);for(var i=0;i<8192;i+=1)this.mem[i]=255;for(var i=0;i<4;i+=1){var e=2048*i;this.mem[e+8]=247,this.mem[e+9]=239,this.mem[e+10]=223,this.mem[e+15]=191}for(var i=8193;i<this.mem.length;i+=1)this.mem[i]=0;this.REG_ACC=0,this.REG_X=0,this.REG_Y=0,this.REG_SP=511,this.REG_PC=32767,this.REG_PC_NEW=32767,this.REG_STATUS=40,this.setStatus(40),this.F_CARRY=0,this.F_DECIMAL=0,this.F_INTERRUPT=1,this.F_INTERRUPT_NEW=1,this.F_OVERFLOW=0,this.F_SIGN=0,this.F_ZERO=1,this.F_NOTUSED=1,this.F_NOTUSED_NEW=1,this.F_BRK=1,this.F_BRK_NEW=1,this.cyclesToHalt=0,this.crash=!1,this.irqRequested=!1,this.irqType=null}return Object.defineProperty(t.prototype,"serializable",{get:function(){return t.serializable},enumerable:!0,configurable:!0}),t.prototype.emulate=function(){var t,i;if(this.irqRequested){switch(t=this.F_CARRY|(0===this.F_ZERO?1:0)<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_BRK<<4|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7,this.REG_PC_NEW=this.REG_PC,this.F_INTERRUPT_NEW=this.F_INTERRUPT,this.irqType){case 0:if(0!=this.F_INTERRUPT)break;this.doIrq(t);break;case 1:this.doNonMaskableInterrupt(t);break;case 2:this.doResetInterrupt()}this.REG_PC=this.REG_PC_NEW,this.F_INTERRUPT=this.F_INTERRUPT_NEW,this.F_BRK=this.F_BRK_NEW,this.irqRequested=!1}var e=f.opdata[this.mapper.load(this.REG_PC+1)],s=e>>24,r=0,h=e>>8&255,a=this.REG_PC;this.REG_PC+=e>>16&255;var n=0;switch(h){case 0:n=this.load(a+2);break;case 1:n=this.load(a+2),n+=n<128?this.REG_PC:this.REG_PC-256;break;case 2:break;case 3:n=this.load16bit(a+2);break;case 4:n=this.REG_ACC;break;case 5:n=this.REG_PC;break;case 6:n=this.load(a+2)+this.REG_X&255;break;case 7:n=this.load(a+2)+this.REG_Y&255;break;case 8:n=this.load16bit(a+2),(65280&n)!=(n+this.REG_X&65280)&&(r=1),n+=this.REG_X;break;case 9:n=this.load16bit(a+2),(65280&n)!=(n+this.REG_Y&65280)&&(r=1),n+=this.REG_Y;break;case 10:n=this.load(a+2),(65280&n)!=(n+this.REG_X&65280)&&(r=1),n+=this.REG_X,n&=255,n=this.load16bit(n);break;case 11:n=this.load16bit(this.load(a+2)),(65280&n)!=(n+this.REG_Y&65280)&&(r=1),n+=this.REG_Y;break;case 12:n=this.load16bit(a+2),n=n<8191?this.mem[n]+(this.mem[65280&n|1+(255&n)&255]<<8):this.mapper.load(n)+(this.mapper.load(65280&n|1+(255&n)&255)<<8)}switch(n&=65535,255&e){case 0:t=this.REG_ACC+this.load(n)+this.F_CARRY,this.F_OVERFLOW=0==(128&(this.REG_ACC^this.load(n)))&&0!=(128&(this.REG_ACC^t))?1:0,this.F_CARRY=t>255?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.REG_ACC=255&t,s+=r;break;case 1:this.REG_ACC=this.REG_ACC&this.load(n),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC,11!=h&&(s+=r);break;case 2:4==h?(this.F_CARRY=this.REG_ACC>>7&1,this.REG_ACC=this.REG_ACC<<1&255,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC):(t=this.load(n),this.F_CARRY=t>>7&1,t=t<<1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.write(n,t));break;case 3:0==this.F_CARRY&&(s+=(65280&a)!=(65280&n)?2:1,this.REG_PC=n);break;case 4:1==this.F_CARRY&&(s+=(65280&a)!=(65280&n)?2:1,this.REG_PC=n);break;case 5:0==this.F_ZERO&&(s+=(65280&a)!=(65280&n)?2:1,this.REG_PC=n);break;case 6:t=this.load(n),this.F_SIGN=t>>7&1,this.F_OVERFLOW=t>>6&1,t&=this.REG_ACC,this.F_ZERO=t;break;case 7:1==this.F_SIGN&&(s++,this.REG_PC=n);break;case 8:0!=this.F_ZERO&&(s+=(65280&a)!=(65280&n)?2:1,this.REG_PC=n);break;case 9:0==this.F_SIGN&&(s+=(65280&a)!=(65280&n)?2:1,this.REG_PC=n);break;case 10:this.REG_PC+=2,this.push(this.REG_PC>>8&255),this.push(255&this.REG_PC),this.F_BRK=1,this.push(this.F_CARRY|(0==this.F_ZERO?1:0)<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_BRK<<4|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7),this.F_INTERRUPT=1,this.REG_PC=this.load16bit(65534),this.REG_PC--;break;case 11:0==this.F_OVERFLOW&&(s+=(65280&a)!=(65280&n)?2:1,this.REG_PC=n);break;case 12:1==this.F_OVERFLOW&&(s+=(65280&a)!=(65280&n)?2:1,this.REG_PC=n);break;case 13:this.F_CARRY=0;break;case 14:this.F_DECIMAL=0;break;case 15:this.F_INTERRUPT=0;break;case 16:this.F_OVERFLOW=0;break;case 17:t=this.REG_ACC-this.load(n),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t,s+=r;break;case 18:t=this.REG_X-this.load(n),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 19:t=this.REG_Y-this.load(n),this.F_CARRY=t>=0?1:0,this.F_SIGN=t>>7&1,this.F_ZERO=255&t;break;case 20:t=this.load(n)-1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.write(n,t);break;case 21:this.REG_X=this.REG_X-1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 22:this.REG_Y=this.REG_Y-1&255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 23:this.REG_ACC=255&(this.load(n)^this.REG_ACC),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC,s+=r;break;case 24:t=this.load(n)+1&255,this.F_SIGN=t>>7&1,this.F_ZERO=t,this.write(n,255&t);break;case 25:this.REG_X=this.REG_X+1&255,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 26:this.REG_Y++,this.REG_Y&=255,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;case 27:this.REG_PC=n-1;break;case 28:this.push(this.REG_PC>>8&255),this.push(255&this.REG_PC),this.REG_PC=n-1;break;case 29:this.REG_ACC=this.load(n),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC,s+=r;break;case 30:this.REG_X=this.load(n),this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X,s+=r;break;case 31:this.REG_Y=this.load(n),this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y,s+=r;break;case 32:4==h?(t=255&this.REG_ACC,this.F_CARRY=1&t,t>>=1,this.REG_ACC=t):(t=255&this.load(n),this.F_CARRY=1&t,t>>=1,this.write(n,t)),this.F_SIGN=0,this.F_ZERO=t;break;case 33:break;case 34:t=255&(this.load(n)|this.REG_ACC),this.F_SIGN=t>>7&1,this.F_ZERO=t,this.REG_ACC=t,11!=h&&(s+=r);break;case 35:this.push(this.REG_ACC);break;case 36:this.F_BRK=1,this.push(this.F_CARRY|(0==this.F_ZERO?1:0)<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_BRK<<4|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7);break;case 37:this.REG_ACC=this.pull(),this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 38:t=this.pull(),this.F_CARRY=1&t,this.F_ZERO=1==(t>>1&1)?0:1,this.F_INTERRUPT=t>>2&1,this.F_DECIMAL=t>>3&1,this.F_BRK=t>>4&1,this.F_NOTUSED=t>>5&1,this.F_OVERFLOW=t>>6&1,this.F_SIGN=t>>7&1,this.F_NOTUSED=1;break;case 39:4==h?(t=this.REG_ACC,i=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+i,this.REG_ACC=t):(t=this.load(n),i=this.F_CARRY,this.F_CARRY=t>>7&1,t=(t<<1&255)+i,this.write(n,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 40:4==h?(i=this.F_CARRY<<7,this.F_CARRY=1&this.REG_ACC,t=(this.REG_ACC>>1)+i,this.REG_ACC=t):(t=this.load(n),i=this.F_CARRY<<7,this.F_CARRY=1&t,t=(t>>1)+i,this.write(n,t)),this.F_SIGN=t>>7&1,this.F_ZERO=t;break;case 41:if(t=this.pull(),this.F_CARRY=1&t,this.F_ZERO=0==(t>>1&1)?1:0,this.F_INTERRUPT=t>>2&1,this.F_DECIMAL=t>>3&1,this.F_BRK=t>>4&1,this.F_NOTUSED=t>>5&1,this.F_OVERFLOW=t>>6&1,this.F_SIGN=t>>7&1,this.REG_PC=this.pull(),this.REG_PC+=this.pull()<<8,65535==this.REG_PC)return;this.REG_PC--,this.F_NOTUSED=1;break;case 42:if(this.REG_PC=this.pull(),this.REG_PC+=this.pull()<<8,65535==this.REG_PC)return;break;case 43:t=this.REG_ACC-this.load(n)-(1-this.F_CARRY),this.F_SIGN=t>>7&1,this.F_ZERO=255&t,this.F_OVERFLOW=0!=(128&(this.REG_ACC^t))&&0!=(128&(this.REG_ACC^this.load(n)))?1:0,this.F_CARRY=t<0?0:1,this.REG_ACC=255&t,11!=h&&(s+=r);break;case 44:this.F_CARRY=1;break;case 45:this.F_DECIMAL=1;break;case 46:this.F_INTERRUPT=1;break;case 47:this.write(n,this.REG_ACC);break;case 48:this.write(n,this.REG_X);break;case 49:this.write(n,this.REG_Y);break;case 50:this.REG_X=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 51:this.REG_Y=this.REG_ACC,this.F_SIGN=this.REG_ACC>>7&1,this.F_ZERO=this.REG_ACC;break;case 52:this.REG_X=this.REG_SP-256,this.F_SIGN=this.REG_SP>>7&1,this.F_ZERO=this.REG_X;break;case 53:this.REG_ACC=this.REG_X,this.F_SIGN=this.REG_X>>7&1,this.F_ZERO=this.REG_X;break;case 54:this.REG_SP=this.REG_X+256,this.stackWrap();break;case 55:this.REG_ACC=this.REG_Y,this.F_SIGN=this.REG_Y>>7&1,this.F_ZERO=this.REG_Y;break;default:throw new Error("Game crashed, invalid opcode at address $"+a.toString(16))}return s},t.prototype.load=function(t){return t<8192?this.mem[2047&t]:this.mapper.load(t)},t.prototype.load16bit=function(t){return t<8191?this.mem[2047&t]|this.mem[t+1&2047]<<8:this.mapper.load(t)|this.mapper.load(t+1)<<8},t.prototype.write=function(t,i){t<8192?this.mem[2047&t]=i:this.mapper.write(t,i)},t.prototype.requestIrq=function(t){this.irqRequested&&t==g.NORMAL||(this.irqRequested=!0,this.irqType=t)},t.prototype.push=function(t){this.mapper.write(this.REG_SP,t),this.REG_SP--,this.REG_SP=256|255&this.REG_SP},t.prototype.stackWrap=function(){this.REG_SP=256|255&this.REG_SP},t.prototype.pull=function(){return this.REG_SP++,this.REG_SP=256|255&this.REG_SP,this.mapper.load(this.REG_SP)},t.prototype.pageCrossed=function(t,i){return(65280&t)!=(65280&i)},t.prototype.haltCycles=function(t){this.cyclesToHalt+=t},t.prototype.doNonMaskableInterrupt=function(t){0!=(128&this.mapper.load(8192))&&(this.REG_PC_NEW++,this.push(this.REG_PC_NEW>>8&255),this.push(255&this.REG_PC_NEW),this.push(t),this.REG_PC_NEW=this.mapper.load(65530)|this.mapper.load(65531)<<8,this.REG_PC_NEW--)},t.prototype.doResetInterrupt=function(){this.REG_PC_NEW=this.mapper.load(65532)|this.mapper.load(65533)<<8,this.REG_PC_NEW--},t.prototype.doIrq=function(t){this.REG_PC_NEW++,this.push(this.REG_PC_NEW>>8&255),this.push(255&this.REG_PC_NEW),this.push(t),this.F_INTERRUPT_NEW=1,this.F_BRK_NEW=0,this.REG_PC_NEW=this.mapper.load(65534)|this.mapper.load(65535)<<8,this.REG_PC_NEW--},t.prototype.getStatus=function(){
return this.F_CARRY|this.F_ZERO<<1|this.F_INTERRUPT<<2|this.F_DECIMAL<<3|this.F_BRK<<4|this.F_NOTUSED<<5|this.F_OVERFLOW<<6|this.F_SIGN<<7},t.prototype.setStatus=function(t){this.F_CARRY=1&t,this.F_ZERO=t>>1&1,this.F_INTERRUPT=t>>2&1,this.F_DECIMAL=t>>3&1,this.F_BRK=t>>4&1,this.F_NOTUSED=t>>5&1,this.F_OVERFLOW=t>>6&1,this.F_SIGN=t>>7&1},t.serializable=["mem","cyclesToHalt","irqRequested","irqType","REG_ACC","REG_X","REG_Y","REG_SP","REG_PC","REG_PC_NEW","REG_STATUS","F_CARRY","F_DECIMAL","F_INTERRUPT","F_INTERRUPT_NEW","F_OVERFLOW","F_SIGN","F_ZERO","F_NOTUSED","F_NOTUSED_NEW","F_BRK","F_BRK_NEW"],t}();!function(t){function i(i,e,s,r,h){t.opdata[e]=255&i|(255&s)<<8|(255&r)<<16|(255&h)<<24}var e;!function(t){t[t.ADC=0]="ADC",t[t.AND=1]="AND",t[t.ASL=2]="ASL",t[t.BCC=3]="BCC",t[t.BCS=4]="BCS",t[t.BEQ=5]="BEQ",t[t.BIT=6]="BIT",t[t.BMI=7]="BMI",t[t.BNE=8]="BNE",t[t.BPL=9]="BPL",t[t.BRK=10]="BRK",t[t.BVC=11]="BVC",t[t.BVS=12]="BVS",t[t.CLC=13]="CLC",t[t.CLD=14]="CLD",t[t.CLI=15]="CLI",t[t.CLV=16]="CLV",t[t.CMP=17]="CMP",t[t.CPX=18]="CPX",t[t.CPY=19]="CPY",t[t.DEC=20]="DEC",t[t.DEX=21]="DEX",t[t.DEY=22]="DEY",t[t.EOR=23]="EOR",t[t.INC=24]="INC",t[t.INX=25]="INX",t[t.INY=26]="INY",t[t.JMP=27]="JMP",t[t.JSR=28]="JSR",t[t.LDA=29]="LDA",t[t.LDX=30]="LDX",t[t.LDY=31]="LDY",t[t.LSR=32]="LSR",t[t.NOP=33]="NOP",t[t.ORA=34]="ORA",t[t.PHA=35]="PHA",t[t.PHP=36]="PHP",t[t.PLA=37]="PLA",t[t.PLP=38]="PLP",t[t.ROL=39]="ROL",t[t.ROR=40]="ROR",t[t.RTI=41]="RTI",t[t.RTS=42]="RTS",t[t.SBC=43]="SBC",t[t.SEC=44]="SEC",t[t.SED=45]="SED",t[t.SEI=46]="SEI",t[t.STA=47]="STA",t[t.STX=48]="STX",t[t.STY=49]="STY",t[t.TAX=50]="TAX",t[t.TAY=51]="TAY",t[t.TSX=52]="TSX",t[t.TXA=53]="TXA",t[t.TXS=54]="TXS",t[t.TYA=55]="TYA",t[t.DUMMY=56]="DUMMY"}(e||(e={}));var s;!function(t){t[t.ZP=0]="ZP",t[t.REL=1]="REL",t[t.IMP=2]="IMP",t[t.ABS=3]="ABS",t[t.ACC=4]="ACC",t[t.IMM=5]="IMM",t[t.ZPX=6]="ZPX",t[t.ZPY=7]="ZPY",t[t.ABSX=8]="ABSX",t[t.ABSY=9]="ABSY",t[t.PREIDXIND=10]="PREIDXIND",t[t.POSTIDXIND=11]="POSTIDXIND",t[t.INDABS=12]="INDABS"}(s||(s={}));t.opdata=new Array(256);for(var r=0;r<256;r++)t.opdata[r]=255;i(e.ADC,105,s.IMM,2,2),i(e.ADC,101,s.ZP,2,3),i(e.ADC,117,s.ZPX,2,4),i(e.ADC,109,s.ABS,3,4),i(e.ADC,125,s.ABSX,3,4),i(e.ADC,121,s.ABSY,3,4),i(e.ADC,97,s.PREIDXIND,2,6),i(e.ADC,113,s.POSTIDXIND,2,5),i(e.AND,41,s.IMM,2,2),i(e.AND,37,s.ZP,2,3),i(e.AND,53,s.ZPX,2,4),i(e.AND,45,s.ABS,3,4),i(e.AND,61,s.ABSX,3,4),i(e.AND,57,s.ABSY,3,4),i(e.AND,33,s.PREIDXIND,2,6),i(e.AND,49,s.POSTIDXIND,2,5),i(e.ASL,10,s.ACC,1,2),i(e.ASL,6,s.ZP,2,5),i(e.ASL,22,s.ZPX,2,6),i(e.ASL,14,s.ABS,3,6),i(e.ASL,30,s.ABSX,3,7),i(e.BCC,144,s.REL,2,2),i(e.BCS,176,s.REL,2,2),i(e.BEQ,240,s.REL,2,2),i(e.BIT,36,s.ZP,2,3),i(e.BIT,44,s.ABS,3,4),i(e.BMI,48,s.REL,2,2),i(e.BNE,208,s.REL,2,2),i(e.BPL,16,s.REL,2,2),i(e.BRK,0,s.IMP,1,7),i(e.BVC,80,s.REL,2,2),i(e.BVS,112,s.REL,2,2),i(e.CLC,24,s.IMP,1,2),i(e.CLD,216,s.IMP,1,2),i(e.CLI,88,s.IMP,1,2),i(e.CLV,184,s.IMP,1,2),i(e.CMP,201,s.IMM,2,2),i(e.CMP,197,s.ZP,2,3),i(e.CMP,213,s.ZPX,2,4),i(e.CMP,205,s.ABS,3,4),i(e.CMP,221,s.ABSX,3,4),i(e.CMP,217,s.ABSY,3,4),i(e.CMP,193,s.PREIDXIND,2,6),i(e.CMP,209,s.POSTIDXIND,2,5),i(e.CPX,224,s.IMM,2,2),i(e.CPX,228,s.ZP,2,3),i(e.CPX,236,s.ABS,3,4),i(e.CPY,192,s.IMM,2,2),i(e.CPY,196,s.ZP,2,3),i(e.CPY,204,s.ABS,3,4),i(e.DEC,198,s.ZP,2,5),i(e.DEC,214,s.ZPX,2,6),i(e.DEC,206,s.ABS,3,6),i(e.DEC,222,s.ABSX,3,7),i(e.DEX,202,s.IMP,1,2),i(e.DEY,136,s.IMP,1,2),i(e.EOR,73,s.IMM,2,2),i(e.EOR,69,s.ZP,2,3),i(e.EOR,85,s.ZPX,2,4),i(e.EOR,77,s.ABS,3,4),i(e.EOR,93,s.ABSX,3,4),i(e.EOR,89,s.ABSY,3,4),i(e.EOR,65,s.PREIDXIND,2,6),i(e.EOR,81,s.POSTIDXIND,2,5),i(e.INC,230,s.ZP,2,5),i(e.INC,246,s.ZPX,2,6),i(e.INC,238,s.ABS,3,6),i(e.INC,254,s.ABSX,3,7),i(e.INX,232,s.IMP,1,2),i(e.INY,200,s.IMP,1,2),i(e.JMP,76,s.ABS,3,3),i(e.JMP,108,s.INDABS,3,5),i(e.JSR,32,s.ABS,3,6),i(e.LDA,169,s.IMM,2,2),i(e.LDA,165,s.ZP,2,3),i(e.LDA,181,s.ZPX,2,4),i(e.LDA,173,s.ABS,3,4),i(e.LDA,189,s.ABSX,3,4),i(e.LDA,185,s.ABSY,3,4),i(e.LDA,161,s.PREIDXIND,2,6),i(e.LDA,177,s.POSTIDXIND,2,5),i(e.LDX,162,s.IMM,2,2),i(e.LDX,166,s.ZP,2,3),i(e.LDX,182,s.ZPY,2,4),i(e.LDX,174,s.ABS,3,4),i(e.LDX,190,s.ABSY,3,4),i(e.LDY,160,s.IMM,2,2),i(e.LDY,164,s.ZP,2,3),i(e.LDY,180,s.ZPX,2,4),i(e.LDY,172,s.ABS,3,4),i(e.LDY,188,s.ABSX,3,4),i(e.LSR,74,s.ACC,1,2),i(e.LSR,70,s.ZP,2,5),i(e.LSR,86,s.ZPX,2,6),i(e.LSR,78,s.ABS,3,6),i(e.LSR,94,s.ABSX,3,7),i(e.NOP,234,s.IMP,1,2),i(e.ORA,9,s.IMM,2,2),i(e.ORA,5,s.ZP,2,3),i(e.ORA,21,s.ZPX,2,4),i(e.ORA,13,s.ABS,3,4),i(e.ORA,29,s.ABSX,3,4),i(e.ORA,25,s.ABSY,3,4),i(e.ORA,1,s.PREIDXIND,2,6),i(e.ORA,17,s.POSTIDXIND,2,5),i(e.PHA,72,s.IMP,1,3),i(e.PHP,8,s.IMP,1,3),i(e.PLA,104,s.IMP,1,4),i(e.PLP,40,s.IMP,1,4),i(e.ROL,42,s.ACC,1,2),i(e.ROL,38,s.ZP,2,5),i(e.ROL,54,s.ZPX,2,6),i(e.ROL,46,s.ABS,3,6),i(e.ROL,62,s.ABSX,3,7),i(e.ROR,106,s.ACC,1,2),i(e.ROR,102,s.ZP,2,5),i(e.ROR,118,s.ZPX,2,6),i(e.ROR,110,s.ABS,3,6),i(e.ROR,126,s.ABSX,3,7),i(e.RTI,64,s.IMP,1,6),i(e.RTS,96,s.IMP,1,6),i(e.SBC,233,s.IMM,2,2),i(e.SBC,229,s.ZP,2,3),i(e.SBC,245,s.ZPX,2,4),i(e.SBC,237,s.ABS,3,4),i(e.SBC,253,s.ABSX,3,4),i(e.SBC,249,s.ABSY,3,4),i(e.SBC,225,s.PREIDXIND,2,6),i(e.SBC,241,s.POSTIDXIND,2,5),i(e.SEC,56,s.IMP,1,2),i(e.SED,248,s.IMP,1,2),i(e.SEI,120,s.IMP,1,2),i(e.STA,133,s.ZP,2,3),i(e.STA,149,s.ZPX,2,4),i(e.STA,141,s.ABS,3,4),i(e.STA,157,s.ABSX,3,5),i(e.STA,153,s.ABSY,3,5),i(e.STA,129,s.PREIDXIND,2,6),i(e.STA,145,s.POSTIDXIND,2,6),i(e.STX,134,s.ZP,2,3),i(e.STX,150,s.ZPY,2,4),i(e.STX,142,s.ABS,3,4),i(e.STY,132,s.ZP,2,3),i(e.STY,148,s.ZPX,2,4),i(e.STY,140,s.ABS,3,4),i(e.TAX,170,s.IMP,1,2),i(e.TAY,168,s.IMP,1,2),i(e.TSX,186,s.IMP,1,2),i(e.TXA,138,s.IMP,1,2),i(e.TXS,154,s.IMP,1,2),i(e.TYA,152,s.IMP,1,2)}(f||(f={}));var C;!function(t){t[t.ADC=0]="ADC",t[t.AND=1]="AND",t[t.ASL=2]="ASL",t[t.BCC=3]="BCC",t[t.BCS=4]="BCS",t[t.BEQ=5]="BEQ",t[t.BIT=6]="BIT",t[t.BMI=7]="BMI",t[t.BNE=8]="BNE",t[t.BPL=9]="BPL",t[t.BRK=10]="BRK",t[t.BVC=11]="BVC",t[t.BVS=12]="BVS",t[t.CLC=13]="CLC",t[t.CLD=14]="CLD",t[t.CLI=15]="CLI",t[t.CLV=16]="CLV",t[t.CMP=17]="CMP",t[t.CPX=18]="CPX",t[t.CPY=19]="CPY",t[t.DEC=20]="DEC",t[t.DEX=21]="DEX",t[t.DEY=22]="DEY",t[t.EOR=23]="EOR",t[t.INC=24]="INC",t[t.INX=25]="INX",t[t.INY=26]="INY",t[t.JMP=27]="JMP",t[t.JSR=28]="JSR",t[t.LDA=29]="LDA",t[t.LDX=30]="LDX",t[t.LDY=31]="LDY",t[t.LSR=32]="LSR",t[t.NOP=33]="NOP",t[t.ORA=34]="ORA",t[t.PHA=35]="PHA",t[t.PHP=36]="PHP",t[t.PLA=37]="PLA",t[t.PLP=38]="PLP",t[t.ROL=39]="ROL",t[t.ROR=40]="ROR",t[t.RTI=41]="RTI",t[t.RTS=42]="RTS",t[t.SBC=43]="SBC",t[t.SEC=44]="SEC",t[t.SED=45]="SED",t[t.SEI=46]="SEI",t[t.STA=47]="STA",t[t.STX=48]="STX",t[t.STY=49]="STY",t[t.TAX=50]="TAX",t[t.TAY=51]="TAY",t[t.TSX=52]="TSX",t[t.TXA=53]="TXA",t[t.TXS=54]="TXS",t[t.TYA=55]="TYA",t[t.DUMMY=56]="DUMMY"}(C||(C={}));var S;!function(t){t[t.ZP=0]="ZP",t[t.REL=1]="REL",t[t.IMP=2]="IMP",t[t.ABS=3]="ABS",t[t.ACC=4]="ACC",t[t.IMM=5]="IMM",t[t.ZPX=6]="ZPX",t[t.ZPY=7]="ZPY",t[t.ABSX=8]="ABSX",t[t.ABSY=9]="ABSY",t[t.PREIDXIND=10]="PREIDXIND",t[t.POSTIDXIND=11]="POSTIDXIND",t[t.INDABS=12]="INDABS"}(S||(S={}));var _=function(){function t(){this.system=null,this.rom=null,this.onsample=null,this.onerror=null}return t.prototype.load=function(t){this.system&&(this.system=null);var i=new D(t);if(!w.romSupported(i))throw new Error("This ROM uses a unsupported mapper: "+i.mapperType);this.rom=i,this.system=new w(this.rom,this.onsample,this.onerror)},t.prototype.reset=function(){this.rom&&(this.system=new w(this.rom,this.onsample,this.onerror))},t.prototype.buttonDown=function(t,i){this.system&&this.system.buttonDown(t,i)},t.prototype.buttonUp=function(t,i){this.system&&this.system.buttonUp(t,i)},t.prototype.frame=function(){return!!this.system&&(!!this.system.frame()||(this.system=null,!1))},t.prototype.pull=function(){return this.system?this.system.pull():null},t}();i.Emulator=_;var y=function(){function t(t,i,e,s,r){this.cpu=t,this.ppu=i,this.apu=e,this.controller=s,this.rom=r,this.joy1StrobeState=0,this.joy2StrobeState=0,this.joypadLastWrite=0,this.mousePressed=!1,this.mouseX=null,this.mouseY=null}return Object.defineProperty(t.prototype,"serializable",{get:function(){return t.serializable},enumerable:!0,configurable:!0}),t.romSupported=function(t){return void 0!==T[t.mapperType]},t.create=function(t,i,e,s,r){var h=new T[r.mapperType](t,i,e,s,r);return h.loadROM(),h},t.prototype.write=function(t,i){t<8192?this.cpu.mem[2047&t]=i:t>16407?this.cpu.mem[t]=i:t>8199&&t<16384?this.regWrite(8192+(7&t),i):this.regWrite(t,i)},t.prototype.writelow=function(t,i){t<8192?this.cpu.mem[2047&t]=i:t>16407?this.cpu.mem[t]=i:t>8199&&t<16384?this.regWrite(8192+(7&t),i):this.regWrite(t,i)},t.prototype.load=function(t){return t&=65535,t>16407?this.cpu.mem[t]:t>=8192?this.regLoad(t):this.cpu.mem[2047&t]},t.prototype.regLoad=function(t){switch(t>>12){case 0:case 1:break;case 2:case 3:switch(7&t){case 0:return this.cpu.mem[8192];case 1:return this.cpu.mem[8193];case 2:return this.ppu.readStatusRegister();case 3:return 0;case 4:return this.ppu.sramLoad();case 5:case 6:return 0;case 7:return this.ppu.vramLoad()}break;case 4:switch(t-16405){case 0:return this.apu.readReg(t);case 1:return this.joy1Read();case 2:if(this.mousePressed){for(var i=Math.max(0,this.mouseX-4),e=Math.min(256,this.mouseX+4),s=Math.max(0,this.mouseY-4),r=Math.min(240,this.mouseY+4),h=0,a=s;a<r;a++)for(var n=i;n<e;n++)if(16777215==this.ppu.buffer[(a<<8)+n]){h|=8,console.debug("Clicked on white!");break}return h|=this.mousePressed?16:0,65535&(this.joy2Read()|h)}return this.joy2Read()}}return 0},t.prototype.regWrite=function(t,i){switch(t){case 8192:this.cpu.mem[t]=i,this.ppu.updateControlReg1(i);break;case 8193:this.cpu.mem[t]=i,this.ppu.updateControlReg2(i);break;case 8195:this.ppu.writeSRAMAddress(i);break;case 8196:this.ppu.sramWrite(i);break;case 8197:this.ppu.scrollWrite(i);break;case 8198:this.ppu.writeVRAMAddress(i);break;case 8199:this.ppu.vramWrite(i);break;case 16404:this.ppu.sramDMA(i);break;case 16405:this.apu.writeReg(t,i);break;case 16406:0==(1&i)&&1==(1&this.joypadLastWrite)&&(this.joy1StrobeState=0,this.joy2StrobeState=0),this.joypadLastWrite=i;break;case 16407:this.apu.writeReg(t,i);break;default:t>=16384&&t<=16407&&this.apu.writeReg(t,i)}},t.prototype.joy1Read=function(){var t;switch(this.joy1StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t=this.controller.state1[this.joy1StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:t=0;break;case 19:t=1;break;default:t=0}return this.joy1StrobeState++,24==this.joy1StrobeState&&(this.joy1StrobeState=0),t},t.prototype.joy2Read=function(){var t;switch(this.joy2StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t=this.controller.state2[this.joy2StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:t=0;break;case 19:t=1;break;default:t=0}return this.joy2StrobeState++,24==this.joy2StrobeState&&(this.joy2StrobeState=0),t},t.prototype.loadROM=function(){this.loadPRGROM(),this.loadCHRROM(),this.loadBatteryRam(),this.cpu.requestIrq(g.RESET)},t.prototype.loadPRGROM=function(){this.rom.romCount>1?(this.loadRomBank(0,32768),this.loadRomBank(1,49152)):(this.loadRomBank(0,32768),this.loadRomBank(0,49152))},t.prototype.loadCHRROM=function(){this.rom.vromCount>0&&(1==this.rom.vromCount?(this.loadVromBank(0,0),this.loadVromBank(0,4096)):(this.loadVromBank(0,0),this.loadVromBank(1,4096)))},t.prototype.loadBatteryRam=function(){},t.prototype.loadRomBank=function(t,i){t%=this.rom.romCount,s(this.rom.rom[t],0,this.cpu.mem,i,16384)},t.prototype.loadVromBank=function(t,i){if(0!==this.rom.vromCount){this.ppu.triggerRendering(),s(this.rom.vrom[t%this.rom.vromCount],0,this.ppu.vramMem,i,4096);s(this.rom.vromTile[t%this.rom.vromCount],0,this.ppu.ptTile,i>>4,256)}},t.prototype.load32kRomBank=function(t,i){this.loadRomBank(2*t%this.rom.romCount,i),this.loadRomBank((2*t+1)%this.rom.romCount,i+16384)},t.prototype.load8kVromBank=function(t,i){0!==this.rom.vromCount&&(this.ppu.triggerRendering(),this.loadVromBank(t%this.rom.vromCount,i),this.loadVromBank((t+1)%this.rom.vromCount,i+4096))},t.prototype.load1kVromBank=function(t,i){if(0!==this.rom.vromCount){this.ppu.triggerRendering();var e=Math.floor(t/4)%this.rom.vromCount,r=t%4*1024;s(this.rom.vrom[e],0,this.ppu.vramMem,r,1024);for(var h=this.rom.vromTile[e],a=i>>4,n=0;n<64;n++)this.ppu.ptTile[a+n]=h[(t%4<<6)+n]}},t.prototype.load2kVromBank=function(t,i){if(0!==this.rom.vromCount){this.ppu.triggerRendering();var e=Math.floor(t/2)%this.rom.vromCount,r=t%2*2048;s(this.rom.vrom[e],r,this.ppu.vramMem,i,2048);for(var h=this.rom.vromTile[e],a=i>>4,n=0;n<128;n++)this.ppu.ptTile[a+n]=h[(t%2<<7)+n]}},t.prototype.load8kRomBank=function(t,i){var e=Math.floor(t/2)%this.rom.romCount,r=t%2*8192;s(this.rom.rom[e],r,this.cpu.mem,i,8192)},t.prototype.clockIrqCounter=function(){},t.prototype.latchAccess=function(t){},t.serializable=["joy1StrobeState","joy2StrobeState","joypadLastWrite"],t}(),T=[];T[0]=y;var E=function(t){function i(i,e,s,r,h){var a=t.call(this,i,e,s,r,h)||this;return a.regBuffer=0,a.regBufferCounter=0,a.mirroring=0,a.oneScreenMirroring=0,a.prgSwitchingArea=1,a.prgSwitchingSize=1,a.vromSwitchingSize=0,a.romSelectionReg0=0,a.romSelectionReg1=0,a.romBankSelect=0,a.regBuffer=0,a.regBufferCounter=0,a.mirroring=0,a.oneScreenMirroring=0,a.prgSwitchingArea=1,a.prgSwitchingSize=1,a.vromSwitchingSize=0,a.romSelectionReg0=0,a.romSelectionReg1=0,a.romBankSelect=0,a}return __extends(i,t),Object.defineProperty(i.prototype,"serializable",{get:function(){return y.serializable},enumerable:!0,configurable:!0}),i.prototype.write=function(i,e){if(i<32768)return void t.prototype.write.call(this,i,e);0!=(128&e)?(this.regBufferCounter=0,this.regBuffer=0,0===this.getRegNumber(i)&&(this.prgSwitchingArea=1,this.prgSwitchingSize=1)):(this.regBuffer=this.regBuffer&255-(1<<this.regBufferCounter)|(1&e)<<this.regBufferCounter,5==++this.regBufferCounter&&(this.setReg(this.getRegNumber(i),this.regBuffer),this.regBuffer=0,this.regBufferCounter=0))},i.prototype.setReg=function(t,i){var e;switch(t){case 0:e=3&i,e!==this.mirroring&&(this.mirroring=e,0==(2&this.mirroring)?this.ppu.setMirroring(I.singleScreen):0!=(1&this.mirroring)?this.ppu.setMirroring(I.horizontal):this.ppu.setMirroring(I.vertical)),this.prgSwitchingArea=i>>2&1,this.prgSwitchingSize=i>>3&1,this.vromSwitchingSize=i>>4&1;break;case 1:this.romSelectionReg0=i>>4&1,this.rom.vromCount>0&&(0===this.vromSwitchingSize?0===this.romSelectionReg0?this.load8kVromBank(15&i,0):this.load8kVromBank(Math.floor(this.rom.vromCount/2)+(15&i),0):0===this.romSelectionReg0?this.loadVromBank(15&i,0):this.loadVromBank(Math.floor(this.rom.vromCount/2)+(15&i),0));break;case 2:this.romSelectionReg1=i>>4&1,this.rom.vromCount>0&&1===this.vromSwitchingSize&&(0===this.romSelectionReg1?this.loadVromBank(15&i,4096):this.loadVromBank(Math.floor(this.rom.vromCount/2)+(15&i),4096));break;default:e=15&i;var s,r=0;this.rom.romCount>=32?0===this.vromSwitchingSize?1===this.romSelectionReg0&&(r=16):r=(this.romSelectionReg0|this.romSelectionReg1<<1)<<3:this.rom.romCount>=16&&1===this.romSelectionReg0&&(r=8),0===this.prgSwitchingSize?(s=r+(15&i),this.load32kRomBank(s,32768)):(s=2*r+(15&i),0===this.prgSwitchingArea?this.loadRomBank(s,49152):this.loadRomBank(s,32768))}},i.prototype.getRegNumber=function(t){return t>=32768&&t<=40959?0:t>=40960&&t<=49151?1:t>=49152&&t<=57343?2:3},i.prototype.loadROM=function(){this.loadRomBank(0,32768),this.loadRomBank(this.rom.romCount-1,49152),this.loadCHRROM(),this.loadBatteryRam(),this.cpu.requestIrq(g.RESET)},i.prototype.switchLowHighPrgRom=function(t){},i.prototype.switch16to32=function(){},i.prototype.switch32to16=function(){},i.serializable=y.serializable.concat("regBuffer","regBufferCounter","mirroring","oneScreenMirroring","prgSwitchingArea","prgSwitchingSize","vromSwitchingSize","romSelectionReg0","romSelectionReg1","romBankSelect"),i}(y);T[1]=E;var A=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.write=function(i,e){i<32768?t.prototype.write.call(this,i,e):this.loadRomBank(e,32768)},i.prototype.loadROM=function(){this.loadRomBank(0,32768),this.loadRomBank(this.rom.romCount-1,49152),this.loadCHRROM(),this.cpu.requestIrq(g.RESET)},i}(y);T[2]=A;var v=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.write=function(i,e){if(i<32768)t.prototype.write.call(this,i,e);else{var s=e%(this.rom.romCount/2)*2;this.loadVromBank(s,0),this.loadVromBank(s+1,4096),this.load8kVromBank(2*e,0)}},i}(y);T[3]=v;var k=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.CMD_SEL_2_1K_VROM_0000=0,i.CMD_SEL_2_1K_VROM_0800=1,i.CMD_SEL_1K_VROM_1000=2,i.CMD_SEL_1K_VROM_1400=3,i.CMD_SEL_1K_VROM_1800=4,i.CMD_SEL_1K_VROM_1C00=5,i.CMD_SEL_ROM_PAGE1=6,i.CMD_SEL_ROM_PAGE2=7,i.command=0,i.prgAddressSelect=0,i.chrAddressSelect=0,i.pageNumber=0,i.irqCounter=0,i.irqLatchValue=0,i.irqEnable=0,i.prgAddressChanged=!1,i}return __extends(i,t),Object.defineProperty(i.prototype,"serializable",{get:function(){return y.serializable},enumerable:!0,configurable:!0}),i.prototype.write=function(i,e){if(i<32768)return void t.prototype.write.call(this,i,e);switch(i){case 32768:this.command=7&e;var s=e>>6&1;s!=this.prgAddressSelect&&(this.prgAddressChanged=!0),this.prgAddressSelect=s,this.chrAddressSelect=e>>7&1;break;case 32769:this.executeCommand(this.command,e);break;case 40960:0!=(1&e)?this.ppu.setMirroring(I.horizontal):this.ppu.setMirroring(I.vertical);break;case 40961:break;case 49152:this.irqCounter=e;break;case 49153:this.irqLatchValue=e;break;case 57344:this.irqEnable=0;break;case 57345:this.irqEnable=1}},i.prototype.executeCommand=function(t,i){switch(t){case this.CMD_SEL_2_1K_VROM_0000:0===this.chrAddressSelect?(this.load1kVromBank(i,0),this.load1kVromBank(i+1,1024)):(this.load1kVromBank(i,4096),this.load1kVromBank(i+1,5120));break;case this.CMD_SEL_2_1K_VROM_0800:0===this.chrAddressSelect?(this.load1kVromBank(i,2048),this.load1kVromBank(i+1,3072)):(this.load1kVromBank(i,6144),this.load1kVromBank(i+1,7168));break;case this.CMD_SEL_1K_VROM_1000:0===this.chrAddressSelect?this.load1kVromBank(i,4096):this.load1kVromBank(i,0);break;case this.CMD_SEL_1K_VROM_1400:0===this.chrAddressSelect?this.load1kVromBank(i,5120):this.load1kVromBank(i,1024);break;case this.CMD_SEL_1K_VROM_1800:0===this.chrAddressSelect?this.load1kVromBank(i,6144):this.load1kVromBank(i,2048);break;case this.CMD_SEL_1K_VROM_1C00:0===this.chrAddressSelect?this.load1kVromBank(i,7168):this.load1kVromBank(i,3072);break;case this.CMD_SEL_ROM_PAGE1:this.prgAddressChanged&&(0===this.prgAddressSelect?this.load8kRomBank(2*(this.rom.romCount-1),49152):this.load8kRomBank(2*(this.rom.romCount-1),32768),this.prgAddressChanged=!1),0===this.prgAddressSelect?this.load8kRomBank(i,32768):this.load8kRomBank(i,49152);break;case this.CMD_SEL_ROM_PAGE2:this.load8kRomBank(i,40960),this.prgAddressChanged&&(0===this.prgAddressSelect?this.load8kRomBank(2*(this.rom.romCount-1),49152):this.load8kRomBank(2*(this.rom.romCount-1),32768),this.prgAddressChanged=!1)}},i.prototype.loadROM=function(){this.load8kRomBank(2*(this.rom.romCount-1),49152),this.load8kRomBank(2*(this.rom.romCount-1)+1,57344),this.load8kRomBank(0,32768),this.load8kRomBank(1,40960),this.loadCHRROM(),this.loadBatteryRam(),this.cpu.requestIrq(g.RESET)},i.prototype.clockIrqCounter=function(){1==this.irqEnable&&--this.irqCounter<0&&(this.cpu.requestIrq(g.NORMAL),this.irqCounter=this.irqLatchValue)},i.serializable=y.serializable.concat("command","prgAddressSelect","chrAddressSelect","pageNumber","irqCounter","irqLatchValue","irqEnable","prgAddressChanged"),i}(y);T[4]=k;var M=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.write=function(i,e){i<32768?t.prototype.write.call(this,i,e):(this.load32kRomBank(e>>4&3,32768),this.load8kVromBank(2*(3&e),0))},i}(y);T[66]=M;var P;!function(t){t[t.VRAMWRITE=4]="VRAMWRITE",t[t.SLSPRITECOUNT=5]="SLSPRITECOUNT",t[t.SPRITE0HIT=6]="SPRITE0HIT",t[t.VBLANK=7]="VBLANK"}(P||(P={}));var I,F=function(){function t(t,i){this.cpu=t,this.writeFrame=i,this.showSpr0Hit=!1,this.clipToTvSize=!0,this.vramMem=new Array(32768),this.spriteMem=new Array(256);for(var e=0;e<this.vramMem.length;e+=1)this.vramMem[e]=0;for(var e=0;e<this.spriteMem.length;e+=1)this.spriteMem[e]=0;this.vramAddress=null,this.vramTmpAddress=null,this.vramBufferedReadValue=0,this.firstWrite=!0,this.sramAddress=0,this.currentMirroring=-1,this.requestEndFrame=!1,this.nmiOk=!1,this.dummyCycleToggle=!1,this.validTileData=!1,this.nmiCounter=0,this.scanlineAlreadyRendered=null,this.f_nmiOnVblank=0,this.f_spriteSize=0,this.f_bgPatternTable=0,this.f_spPatternTable=0,this.f_addrInc=0,this.f_nTblAddress=0,this.f_color=0,this.f_spVisibility=0,this.f_bgVisibility=0,this.f_spClipping=0,this.f_bgClipping=0,this.f_dispType=0,this.cntFV=0,this.cntV=0,this.cntH=0,this.cntVT=0,this.cntHT=0,this.regFV=0,this.regV=0,this.regH=0,this.regVT=0,this.regHT=0,this.regFH=0,this.regS=0,this.curNt=null,this.attrib=new Array(32),this.buffer=new Array(61440),this.bgbuffer=new Array(61440),this.pixrendered=new Array(61440),this.scantile=new Array(32),this.scanline=0,this.lastRenderedScanline=-1,this.curX=0,this.sprX=new Array(64),this.sprY=new Array(64),this.sprTile=new Array(64),this.sprCol=new Array(64),this.vertFlip=new Array(64),this.horiFlip=new Array(64),this.bgPriority=new Array(64),this.spr0HitX=0,this.spr0HitY=0,this.hitSpr0=!1,this.sprPalette=new Array(16),this.imgPalette=new Array(16),this.ptTile=new Array(512);for(var e=0;e<512;e+=1)this.ptTile[e]=new B;this.ntable1=new Array(4),this.currentMirroring=-1,this.nameTable=new Array(4);for(var e=0;e<4;e+=1)this.nameTable[e]=new L(32,32,"Nt"+e);this.vramMirrorTable=new Array(32768);for(var e=0;e<32768;e+=1)this.vramMirrorTable[e]=e;this.palTable=new V,this.palTable.loadNTSCPalette(),this.updateControlReg1(0),this.updateControlReg2(0)}return Object.defineProperty(t.prototype,"serializable",{get:function(){return t.serializable},enumerable:!0,configurable:!0}),t.prototype.setMirroring=function(t){if(t!=this.currentMirroring){this.currentMirroring=t,this.triggerRendering(),null===this.vramMirrorTable&&(this.vramMirrorTable=new Array(32768));for(var i=0;i<32768;i+=1)this.vramMirrorTable[i]=i;this.defineMirrorRegion(16160,16128,32),this.defineMirrorRegion(16192,16128,32),this.defineMirrorRegion(16256,16128,32),this.defineMirrorRegion(16320,16128,32),this.defineMirrorRegion(12288,8192,3840),this.defineMirrorRegion(16384,0,16384),t==I.horizontal?(this.ntable1[0]=0,this.ntable1[1]=0,this.ntable1[2]=1,this.ntable1[3]=1,this.defineMirrorRegion(9216,8192,1024),this.defineMirrorRegion(11264,10240,1024)):t==I.vertical?(this.ntable1[0]=0,this.ntable1[1]=1,this.ntable1[2]=0,this.ntable1[3]=1,this.defineMirrorRegion(10240,8192,1024),this.defineMirrorRegion(11264,9216,1024)):t==I.singleScreen?(this.ntable1[0]=0,this.ntable1[1]=0,this.ntable1[2]=0,this.ntable1[3]=0,this.defineMirrorRegion(9216,8192,1024),this.defineMirrorRegion(10240,8192,1024),this.defineMirrorRegion(11264,8192,1024)):t==I.singleScreen2?(this.ntable1[0]=1,this.ntable1[1]=1,this.ntable1[2]=1,this.ntable1[3]=1,this.defineMirrorRegion(9216,9216,1024),this.defineMirrorRegion(10240,9216,1024),this.defineMirrorRegion(11264,9216,1024)):(this.ntable1[0]=0,this.ntable1[1]=1,this.ntable1[2]=2,this.ntable1[3]=3)}},t.prototype.defineMirrorRegion=function(t,i,e){for(var s=0;s<e;s+=1)this.vramMirrorTable[t+s]=i+s},t.prototype.startVBlank=function(){this.cpu.requestIrq(g.NMI),this.lastRenderedScanline<239&&this.renderFramePartially(this.lastRenderedScanline+1,240-this.lastRenderedScanline),this.endFrame(),this.lastRenderedScanline=-1},t.prototype.endScanline=function(){switch(this.scanline){case 19:this.dummyCycleToggle&&(this.curX=1,this.dummyCycleToggle=!this.dummyCycleToggle);break;case 20:this.setStatusFlag(P.VBLANK,!1),this.setStatusFlag(P.SPRITE0HIT,!1),this.hitSpr0=!1,this.spr0HitX=-1,this.spr0HitY=-1,1!=this.f_bgVisibility&&1!=this.f_spVisibility||(this.cntFV=this.regFV,this.cntV=this.regV,this.cntH=this.regH,this.cntVT=this.regVT,this.cntHT=this.regHT,1==this.f_bgVisibility&&this.renderBgScanline(!1,0)),1==this.f_bgVisibility&&1==this.f_spVisibility&&this.checkSprite0(0),1!=this.f_bgVisibility&&1!=this.f_spVisibility||this.cpu.mapper.clockIrqCounter();break;case 261:this.setStatusFlag(P.VBLANK,!0),this.requestEndFrame=!0,this.nmiCounter=9,this.scanline=-1;break;default:this.scanline>=21&&this.scanline<=260&&(1==this.f_bgVisibility&&(this.scanlineAlreadyRendered||(this.cntHT=this.regHT,this.cntH=this.regH,this.renderBgScanline(!0,this.scanline+1-21)),this.scanlineAlreadyRendered=!1,this.hitSpr0||1!=this.f_spVisibility||this.sprX[0]>=-7&&this.sprX[0]<256&&this.sprY[0]+1<=this.scanline-20&&this.sprY[0]+1+(0===this.f_spriteSize?8:16)>=this.scanline-20&&this.checkSprite0(this.scanline-20)&&(this.hitSpr0=!0)),1!=this.f_bgVisibility&&1!=this.f_spVisibility||this.cpu.mapper.clockIrqCounter())}this.scanline+=1,this.regsToAddress(),this.cntsToAddress()},t.prototype.startFrame=function(){var t=0;if(0===this.f_dispType)t=this.imgPalette[0];else switch(this.f_color){case 0:t=0;break;case 1:t=65280;break;case 2:t=16711680;break;case 3:t=0;break;case 4:t=255;break;default:t=0}var i,e=this.buffer;for(i=0;i<61440;i+=1)e[i]=t;var s=this.pixrendered;for(i=0;i<s.length;i+=1)s[i]=65},t.prototype.endFrame=function(){var t,i,e,s=this.buffer;if(this.showSpr0Hit){if(this.sprX[0]>=0&&this.sprX[0]<256&&this.sprY[0]>=0&&this.sprY[0]<240){for(t=0;t<256;t+=1)s[(this.sprY[0]<<8)+t]=16733525;for(t=0;t<240;t+=1)s[(t<<8)+this.sprX[0]]=16733525}if(this.spr0HitX>=0&&this.spr0HitX<256&&this.spr0HitY>=0&&this.spr0HitY<240){for(t=0;t<256;t+=1)s[(this.spr0HitY<<8)+t]=5635925;for(t=0;t<256;t+=1)s[(t<<8)+this.spr0HitX]=5635925}}if(this.clipToTvSize||0===this.f_bgClipping||0===this.f_spClipping)for(e=0;e<240;e+=1)for(i=0;i<8;i+=1)s[(e<<8)+i]=0;if(this.clipToTvSize)for(e=0;e<240;e+=1)for(i=0;i<8;i+=1)s[255+(e<<8)-i]=0;if(this.clipToTvSize)for(e=0;e<240;e+=1)for(i=0;i<8;i+=1)s[(e<<8)+i]=0,s[(239-e<<8)+i]=0;this.writeFrame(s)},t.prototype.updateControlReg1=function(t){this.triggerRendering(),this.f_nmiOnVblank=t>>7&1,this.f_spriteSize=t>>5&1,this.f_bgPatternTable=t>>4&1,this.f_spPatternTable=t>>3&1,this.f_addrInc=t>>2&1,this.f_nTblAddress=3&t,this.regV=t>>1&1,this.regH=1&t,this.regS=t>>4&1},t.prototype.updateControlReg2=function(t){this.triggerRendering(),this.f_color=t>>5&7,this.f_spVisibility=t>>4&1,this.f_bgVisibility=t>>3&1,this.f_spClipping=t>>2&1,this.f_bgClipping=t>>1&1,this.f_dispType=1&t,0===this.f_dispType&&this.palTable.setEmphasis(this.f_color),this.updatePalettes()},t.prototype.setStatusFlag=function(t,i){var e=1<<t;this.cpu.mem[8194]=this.cpu.mem[8194]&255-e|(i?e:0)},t.prototype.readStatusRegister=function(){var t=this.cpu.mem[8194];return this.firstWrite=!0,this.setStatusFlag(P.VBLANK,!1),t},t.prototype.writeSRAMAddress=function(t){this.sramAddress=t},t.prototype.sramLoad=function(){return this.spriteMem[this.sramAddress]},t.prototype.sramWrite=function(t){this.spriteMem[this.sramAddress]=t,this.spriteRamWriteUpdate(this.sramAddress,t),this.sramAddress++,this.sramAddress%=256},t.prototype.scrollWrite=function(t){this.triggerRendering(),this.firstWrite?(this.regHT=t>>3&31,this.regFH=7&t):(this.regFV=7&t,this.regVT=t>>3&31),this.firstWrite=!this.firstWrite},t.prototype.writeVRAMAddress=function(t){this.firstWrite?(this.regFV=t>>4&3,this.regV=t>>3&1,this.regH=t>>2&1,this.regVT=7&this.regVT|(3&t)<<3):(this.triggerRendering(),this.regVT=24&this.regVT|t>>5&7,this.regHT=31&t,this.cntFV=this.regFV,this.cntV=this.regV,this.cntH=this.regH,this.cntVT=this.regVT,this.cntHT=this.regHT,this.checkSprite0(this.scanline-20)),this.firstWrite=!this.firstWrite,this.cntsToAddress(),this.vramAddress<8192&&this.cpu.mapper.latchAccess(this.vramAddress)},t.prototype.vramLoad=function(){var t;return this.cntsToAddress(),this.regsToAddress(),this.vramAddress<=16127?(t=this.vramBufferedReadValue,this.vramAddress<8192?this.vramBufferedReadValue=this.vramMem[this.vramAddress]:this.vramBufferedReadValue=this.mirroredLoad(this.vramAddress),this.vramAddress<8192&&this.cpu.mapper.latchAccess(this.vramAddress),this.vramAddress+=1==this.f_addrInc?32:1,this.cntsFromAddress(),this.regsFromAddress(),t):(t=this.mirroredLoad(this.vramAddress),this.vramAddress+=1==this.f_addrInc?32:1,this.cntsFromAddress(),this.regsFromAddress(),t)},t.prototype.vramWrite=function(t){this.triggerRendering(),this.cntsToAddress(),this.regsToAddress(),this.vramAddress>=8192?this.mirroredWrite(this.vramAddress,t):(this.writeMem(this.vramAddress,t),this.cpu.mapper.latchAccess(this.vramAddress)),this.vramAddress+=1==this.f_addrInc?32:1,this.regsFromAddress(),this.cntsFromAddress()},t.prototype.sramDMA=function(t){for(var i,e=256*t,s=this.sramAddress;s<256;s++)i=this.cpu.mem[e+s],this.spriteMem[s]=i,this.spriteRamWriteUpdate(s,i);this.cpu.haltCycles(513)},t.prototype.regsFromAddress=function(){var t=this.vramTmpAddress>>8&255;this.regFV=t>>4&7,this.regV=t>>3&1,this.regH=t>>2&1,this.regVT=7&this.regVT|(3&t)<<3,t=255&this.vramTmpAddress,this.regVT=24&this.regVT|t>>5&7,this.regHT=31&t},t.prototype.cntsFromAddress=function(){var t=this.vramAddress>>8&255;this.cntFV=t>>4&3,this.cntV=t>>3&1,this.cntH=t>>2&1,this.cntVT=7&this.cntVT|(3&t)<<3,t=255&this.vramAddress,this.cntVT=24&this.cntVT|t>>5&7,this.cntHT=31&t},t.prototype.regsToAddress=function(){var t=(7&this.regFV)<<4;t|=(1&this.regV)<<3,t|=(1&this.regH)<<2,t|=this.regVT>>3&3;var i=(7&this.regVT)<<5;i|=31&this.regHT,this.vramTmpAddress=32767&(t<<8|i)},t.prototype.cntsToAddress=function(){var t=(7&this.cntFV)<<4;t|=(1&this.cntV)<<3,t|=(1&this.cntH)<<2,t|=this.cntVT>>3&3;var i=(7&this.cntVT)<<5;i|=31&this.cntHT,this.vramAddress=32767&(t<<8|i)},t.prototype.incTileCounter=function(t){for(var i=t;0!==i;i--)32==++this.cntHT&&(this.cntHT=0,++this.cntVT>=30&&2==++this.cntH&&(this.cntH=0,2==++this.cntV&&(this.cntV=0,this.cntFV++,this.cntFV&=7)))},t.prototype.mirroredLoad=function(t){return this.vramMem[this.vramMirrorTable[t]]},t.prototype.mirroredWrite=function(t,i){t>=16128&&t<16160?16128==t||16144==t?(this.writeMem(16128,i),this.writeMem(16144,i)):16132==t||16148==t?(this.writeMem(16132,i),this.writeMem(16148,i)):16136==t||16152==t?(this.writeMem(16136,i),this.writeMem(16152,i)):16140==t||16156==t?(this.writeMem(16140,i),this.writeMem(16156,i)):this.writeMem(t,i):t<this.vramMirrorTable.length?this.writeMem(this.vramMirrorTable[t],i):alert("Invalid VRAM address: "+t.toString(16))},t.prototype.triggerRendering=function(){this.scanline>=21&&this.scanline<=260&&(this.renderFramePartially(this.lastRenderedScanline+1,this.scanline-21-this.lastRenderedScanline),this.lastRenderedScanline=this.scanline-21)},t.prototype.renderFramePartially=function(t,i){if(1==this.f_spVisibility&&this.renderSpritesPartially(t,i,!0),1==this.f_bgVisibility){var e=t<<8,s=t+i<<8;s>61440&&(s=61440);for(var r=this.buffer,h=this.bgbuffer,a=this.pixrendered,n=e;n<s;n++)a[n]>255&&(r[n]=h[n])}1==this.f_spVisibility&&this.renderSpritesPartially(t,i,!1),this.validTileData=!1},t.prototype.renderBgScanline=function(t,i){var e=0===this.regS?0:256,s=(i<<8)-this.regFH;if(this.curNt=this.ntable1[this.cntV+this.cntV+this.cntH],this.cntHT=this.regHT,this.cntH=this.regH,this.curNt=this.ntable1[this.cntV+this.cntV+this.cntH],i<240&&i-this.cntFV>=0){for(var r,h,a,n,o=this.cntFV<<3,l=this.scantile,p=this.attrib,u=this.ptTile,c=this.nameTable,m=this.imgPalette,d=this.pixrendered,g=t?this.bgbuffer:this.buffer,R=0;R<32;R++){if(i>=0){if(this.validTileData){if(void 0===(r=l[R]))continue;h=r.pix,a=p[R]}else{if(void 0===(r=u[e+c[this.curNt].getTileIndex(this.cntHT,this.cntVT)]))continue;h=r.pix,a=c[this.curNt].getAttrib(this.cntHT,this.cntVT),l[R]=r,p[R]=a}var f=0,b=(R<<3)-this.regFH;if(b>-8)if(b<0&&(s-=b,f=-b),r.opaque[this.cntFV])for(;f<8;f++)g[s]=m[h[o+f]+a],d[s]|=256,s++;else for(;f<8;f++)n=h[o+f],0!==n&&(g[s]=m[n+a],d[s]|=256),s++}32==++this.cntHT&&(this.cntHT=0,
this.cntH++,this.cntH%=2,this.curNt=this.ntable1[(this.cntV<<1)+this.cntH])}this.validTileData=!0}8==++this.cntFV&&(this.cntFV=0,this.cntVT++,30==this.cntVT?(this.cntVT=0,this.cntV++,this.cntV%=2,this.curNt=this.ntable1[(this.cntV<<1)+this.cntH]):32==this.cntVT&&(this.cntVT=0),this.validTileData=!1)},t.prototype.renderSpritesPartially=function(t,i,e){if(1===this.f_spVisibility)for(var s=0;s<64;s++)if(this.bgPriority[s]==e&&this.sprX[s]>=0&&this.sprX[s]<256&&this.sprY[s]+8>=t&&this.sprY[s]<t+i)if(0===this.f_spriteSize){var r=0,h=8;this.sprY[s]<t&&(r=t-this.sprY[s]-1),this.sprY[s]+8>t+i&&(h=t+i-this.sprY[s]+1),0===this.f_spPatternTable?this.ptTile[this.sprTile[s]].render(this.buffer,0,r,8,h,this.sprX[s],this.sprY[s]+1,this.sprCol[s],this.sprPalette,this.horiFlip[s],this.vertFlip[s],s,this.pixrendered):this.ptTile[this.sprTile[s]+256].render(this.buffer,0,r,8,h,this.sprX[s],this.sprY[s]+1,this.sprCol[s],this.sprPalette,this.horiFlip[s],this.vertFlip[s],s,this.pixrendered)}else{var a=this.sprTile[s];0!=(1&a)&&(a=this.sprTile[s]-1+256);var r=0,h=8;this.sprY[s]<t&&(r=t-this.sprY[s]-1),this.sprY[s]+8>t+i&&(h=t+i-this.sprY[s]),this.ptTile[a+(this.vertFlip[s]?1:0)].render(this.buffer,0,r,8,h,this.sprX[s],this.sprY[s]+1,this.sprCol[s],this.sprPalette,this.horiFlip[s],this.vertFlip[s],s,this.pixrendered),r=0,h=8,this.sprY[s]+8<t&&(r=t-(this.sprY[s]+8+1)),this.sprY[s]+16>t+i&&(h=t+i-(this.sprY[s]+8)),this.ptTile[a+(this.vertFlip[s]?0:1)].render(this.buffer,0,r,8,h,this.sprX[s],this.sprY[s]+1+8,this.sprCol[s],this.sprPalette,this.horiFlip[s],this.vertFlip[s],s,this.pixrendered)}},t.prototype.checkSprite0=function(t){this.spr0HitX=-1,this.spr0HitY=-1;var i,e,s,r,h,a,n=0===this.f_spPatternTable?0:256;if(e=this.sprX[0],s=this.sprY[0]+1,0===this.f_spriteSize){if(s<=t&&s+8>t&&e>=-7&&e<256)if(r=this.ptTile[this.sprTile[0]+n],this.sprCol[0],this.bgPriority[0],i=this.vertFlip[0]?7-(t-s):t-s,i*=8,a=256*t+e,this.horiFlip[0])for(h=7;h>=0;h--){if(e>=0&&e<256&&a>=0&&a<61440&&0!==this.pixrendered[a]&&0!==r.pix[i+h])return this.spr0HitX=a%256,this.spr0HitY=t,!0;e++,a++}else for(h=0;h<8;h++){if(e>=0&&e<256&&a>=0&&a<61440&&0!==this.pixrendered[a]&&0!==r.pix[i+h])return this.spr0HitX=a%256,this.spr0HitY=t,!0;e++,a++}}else if(s<=t&&s+16>t&&e>=-7&&e<256)if(i=this.vertFlip[0]?15-(t-s):t-s,i<8?r=this.ptTile[this.sprTile[0]+(this.vertFlip[0]?1:0)+(0!=(1&this.sprTile[0])?255:0)]:(r=this.ptTile[this.sprTile[0]+(this.vertFlip[0]?0:1)+(0!=(1&this.sprTile[0])?255:0)],this.vertFlip[0]?i=15-i:i-=8),i*=8,this.sprCol[0],this.bgPriority[0],a=256*t+e,this.horiFlip[0])for(h=7;h>=0;h--){if(e>=0&&e<256&&a>=0&&a<61440&&0!==this.pixrendered[a]&&0!==r.pix[i+h])return this.spr0HitX=a%256,this.spr0HitY=t,!0;e++,a++}else for(h=0;h<8;h++){if(e>=0&&e<256&&a>=0&&a<61440&&0!==this.pixrendered[a]&&0!==r.pix[i+h])return this.spr0HitX=a%256,this.spr0HitY=t,!0;e++,a++}return!1},t.prototype.writeMem=function(t,i){this.vramMem[t]=i,t<8192?(this.vramMem[t]=i,this.patternWrite(t,i)):t>=8192&&t<9152?this.nameTableWrite(this.ntable1[0],t-8192,i):t>=9152&&t<9216?this.attribTableWrite(this.ntable1[0],t-9152,i):t>=9216&&t<10176?this.nameTableWrite(this.ntable1[1],t-9216,i):t>=10176&&t<10240?this.attribTableWrite(this.ntable1[1],t-10176,i):t>=10240&&t<11200?this.nameTableWrite(this.ntable1[2],t-10240,i):t>=11200&&t<11264?this.attribTableWrite(this.ntable1[2],t-11200,i):t>=11264&&t<12224?this.nameTableWrite(this.ntable1[3],t-11264,i):t>=12224&&t<12288?this.attribTableWrite(this.ntable1[3],t-12224,i):t>=16128&&t<16160&&this.updatePalettes()},t.prototype.updatePalettes=function(){var t;for(t=0;t<16;t++)0===this.f_dispType?this.imgPalette[t]=this.palTable.getEntry(63&this.vramMem[16128+t]):this.imgPalette[t]=this.palTable.getEntry(32&this.vramMem[16128+t]);for(t=0;t<16;t++)0===this.f_dispType?this.sprPalette[t]=this.palTable.getEntry(63&this.vramMem[16144+t]):this.sprPalette[t]=this.palTable.getEntry(32&this.vramMem[16144+t])},t.prototype.patternWrite=function(t,i){var e=Math.floor(t/16),s=t%16;s<8?this.ptTile[e].setScanline(s,i,this.vramMem[t+8]):this.ptTile[e].setScanline(s-8,this.vramMem[t-8],i)},t.prototype.nameTableWrite=function(t,i,e){this.nameTable[t].tile[i]=e,this.checkSprite0(this.scanline-20)},t.prototype.attribTableWrite=function(t,i,e){this.nameTable[t].writeAttrib(i,e)},t.prototype.spriteRamWriteUpdate=function(t,i){var e=Math.floor(t/4);0===e&&this.checkSprite0(this.scanline-20),t%4==0?this.sprY[e]=i:t%4==1?this.sprTile[e]=i:t%4==2?(this.vertFlip[e]=0!=(128&i),this.horiFlip[e]=0!=(64&i),this.bgPriority[e]=0!=(32&i),this.sprCol[e]=(3&i)<<2):t%4==3&&(this.sprX[e]=i)},t.prototype.doNMI=function(){this.setStatusFlag(P.VBLANK,!0),this.cpu.requestIrq(g.NMI)},t.serializable=["vramMem","spriteMem","cntFV","cntV","cntH","cntVT","cntHT","regFV","regV","regH","regVT","regHT","regFH","regS","vramAddress","vramTmpAddress","f_nmiOnVblank","f_spriteSize","f_bgPatternTable","f_spPatternTable","f_addrInc","f_nTblAddress","f_color","f_spVisibility","f_bgVisibility","f_spClipping","f_bgClipping","f_dispType","vramBufferedReadValue","firstWrite","currentMirroring","vramMirrorTable","ntable1","sramAddress","hitSpr0","sprPalette","imgPalette","curX","scanline","lastRenderedScanline","curNt","scantile","attrib","buffer","bgbuffer","pixrendered","requestEndFrame","nmiOk","dummyCycleToggle","nmiCounter","validTileData","scanlineAlreadyRendered"],t}(),L=function(){function t(t,i,e){this.width=t,this.height=i,this.name=e,this.tile=new Array(t*i),this.attrib=new Array(t*i);for(var s=0;s<t*i;s+=1)this.tile[s]=0,this.attrib[s]=0}return Object.defineProperty(t.prototype,"serializable",{get:function(){return t.serializable},enumerable:!0,configurable:!0}),t.prototype.getTileIndex=function(t,i){return this.tile[i*this.width+t]},t.prototype.getAttrib=function(t,i){return this.attrib[i*this.width+t]},t.prototype.writeAttrib=function(t,i){for(var e,s,r,h=t%8*4,a=4*Math.floor(t/8),n=0;n<2;n++)for(var o=0;o<2;o++){e=i>>2*(2*n+o)&3;for(var l=0;l<2;l++)for(var p=0;p<2;p++)s=h+2*o+p,r=a+2*n+l,r*this.width+s,this.attrib[r*this.width+s]=e<<2&12}},t.serializable=["tile","attrib"],t}(),V=function(){function t(){this.curTable=new Array(64),this.emphTable=new Array(8),this.currentEmph=-1}return t.prototype.loadNTSCPalette=function(){this.curTable=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0],this.makeTables(),this.setEmphasis(0)},t.prototype.loadPALPalette=function(){this.curTable=[5395026,11796480,10485760,11599933,7602281,91,95,6208,12048,543240,26368,1196544,7153664,0,0,0,12899815,16728064,14421538,16729963,14090399,6818519,6588,21681,27227,35843,43776,2918400,10777088,0,0,0,16316664,16755516,16742785,16735173,16730354,14633471,4681215,46327,57599,58229,259115,7911470,15065624,7895160,0,0,16777215,16773822,16300216,16300248,16758527,16761855,13095423,10148607,8973816,8650717,12122296,16119980,16777136,16308472,0,0],this.makeTables(),this.setEmphasis(0)},t.prototype.makeTables=function(){for(var t,i,e,s,r,h,a,n,o=0;o<8;o++)for(h=1,a=1,n=1,0!=(1&o)&&(h=.75,n=.75),0!=(2&o)&&(h=.75,a=.75),0!=(4&o)&&(a=.75,n=.75),this.emphTable[o]=new Array(64),r=0;r<64;r++)s=this.curTable[r],t=Math.floor(this.getRed(s)*h),i=Math.floor(this.getGreen(s)*a),e=Math.floor(this.getBlue(s)*n),this.emphTable[o][r]=this.getRgb(t,i,e)},t.prototype.setEmphasis=function(t){if(t!=this.currentEmph){this.currentEmph=t;for(var i=0;i<64;i++)this.curTable[i]=this.emphTable[t][i]}},t.prototype.getEntry=function(t){return this.curTable[t]},t.prototype.getRed=function(t){return t>>16&255},t.prototype.getGreen=function(t){return t>>8&255},t.prototype.getBlue=function(t){return 255&t},t.prototype.getRgb=function(t,i,e){return t<<16|i<<8|e},t.prototype.loadDefaultPalette=function(){this.curTable[0]=this.getRgb(117,117,117),this.curTable[1]=this.getRgb(39,27,143),this.curTable[2]=this.getRgb(0,0,171),this.curTable[3]=this.getRgb(71,0,159),this.curTable[4]=this.getRgb(143,0,119),this.curTable[5]=this.getRgb(171,0,19),this.curTable[6]=this.getRgb(167,0,0),this.curTable[7]=this.getRgb(127,11,0),this.curTable[8]=this.getRgb(67,47,0),this.curTable[9]=this.getRgb(0,71,0),this.curTable[10]=this.getRgb(0,81,0),this.curTable[11]=this.getRgb(0,63,23),this.curTable[12]=this.getRgb(27,63,95),this.curTable[13]=this.getRgb(0,0,0),this.curTable[14]=this.getRgb(0,0,0),this.curTable[15]=this.getRgb(0,0,0),this.curTable[16]=this.getRgb(188,188,188),this.curTable[17]=this.getRgb(0,115,239),this.curTable[18]=this.getRgb(35,59,239),this.curTable[19]=this.getRgb(131,0,243),this.curTable[20]=this.getRgb(191,0,191),this.curTable[21]=this.getRgb(231,0,91),this.curTable[22]=this.getRgb(219,43,0),this.curTable[23]=this.getRgb(203,79,15),this.curTable[24]=this.getRgb(139,115,0),this.curTable[25]=this.getRgb(0,151,0),this.curTable[26]=this.getRgb(0,171,0),this.curTable[27]=this.getRgb(0,147,59),this.curTable[28]=this.getRgb(0,131,139),this.curTable[29]=this.getRgb(0,0,0),this.curTable[30]=this.getRgb(0,0,0),this.curTable[31]=this.getRgb(0,0,0),this.curTable[32]=this.getRgb(255,255,255),this.curTable[33]=this.getRgb(63,191,255),this.curTable[34]=this.getRgb(95,151,255),this.curTable[35]=this.getRgb(167,139,253),this.curTable[36]=this.getRgb(247,123,255),this.curTable[37]=this.getRgb(255,119,183),this.curTable[38]=this.getRgb(255,119,99),this.curTable[39]=this.getRgb(255,155,59),this.curTable[40]=this.getRgb(243,191,63),this.curTable[41]=this.getRgb(131,211,19),this.curTable[42]=this.getRgb(79,223,75),this.curTable[43]=this.getRgb(88,248,152),this.curTable[44]=this.getRgb(0,235,219),this.curTable[45]=this.getRgb(0,0,0),this.curTable[46]=this.getRgb(0,0,0),this.curTable[47]=this.getRgb(0,0,0),this.curTable[48]=this.getRgb(255,255,255),this.curTable[49]=this.getRgb(171,231,255),this.curTable[50]=this.getRgb(199,215,255),this.curTable[51]=this.getRgb(215,203,255),this.curTable[52]=this.getRgb(255,199,255),this.curTable[53]=this.getRgb(255,199,219),this.curTable[54]=this.getRgb(255,191,179),this.curTable[55]=this.getRgb(255,219,171),this.curTable[56]=this.getRgb(255,231,163),this.curTable[57]=this.getRgb(227,255,163),this.curTable[58]=this.getRgb(171,243,191),this.curTable[59]=this.getRgb(179,255,207),this.curTable[60]=this.getRgb(159,255,243),this.curTable[61]=this.getRgb(0,0,0),this.curTable[62]=this.getRgb(0,0,0),this.curTable[63]=this.getRgb(0,0,0),this.makeTables(),this.setEmphasis(0)},t}(),B=function(){function t(){this.pix=new Array(64),this.opaque=new Array(8),this.initialized=!1,this.fbIndex=null,this.tIndex=null,this.x=null,this.y=null,this.w=null,this.h=null,this.incX=null,this.incY=null,this.palIndex=null,this.tpri=null,this.c=null}return Object.defineProperty(t.prototype,"serializable",{get:function(){return t.serializable},enumerable:!0,configurable:!0}),t.prototype.setBuffer=function(t){for(this.y=0;this.y<8;this.y+=1)this.setScanline(this.y,t[this.y],t[this.y+8])},t.prototype.setScanline=function(t,i,e){for(this.initialized=!0,this.tIndex=t<<3,this.x=0;this.x<8;this.x+=1)this.pix[this.tIndex+this.x]=(i>>7-this.x&1)+((e>>7-this.x&1)<<1),0===this.pix[this.tIndex+this.x]&&(this.opaque[t]=!1)},t.prototype.render=function(t,i,e,s,r,h,a,n,o,l,p,u,c){if(!(h<-7||h>=256||a<-7||a>=240))if(this.w=s-i,this.h=r-e,h<0&&(i-=h),h+s>=256&&(s=256-h),a<0&&(e-=a),a+r>=240&&(r=240-a),l||p)if(l&&!p)for(this.fbIndex=(a<<8)+h,this.tIndex=7,this.y=0;this.y<8;this.y++){for(this.x=0;this.x<8;this.x++)this.x>=i&&this.x<s&&this.y>=e&&this.y<r&&(this.palIndex=this.pix[this.tIndex],this.tpri=c[this.fbIndex],0!==this.palIndex&&u<=(255&this.tpri)&&(t[this.fbIndex]=o[this.palIndex+n],this.tpri=3840&this.tpri|u,c[this.fbIndex]=this.tpri)),this.fbIndex++,this.tIndex--;this.fbIndex-=8,this.fbIndex+=256,this.tIndex+=16}else if(p&&!l)for(this.fbIndex=(a<<8)+h,this.tIndex=56,this.y=0;this.y<8;this.y++){for(this.x=0;this.x<8;this.x++)this.x>=i&&this.x<s&&this.y>=e&&this.y<r&&(this.palIndex=this.pix[this.tIndex],this.tpri=c[this.fbIndex],0!==this.palIndex&&u<=(255&this.tpri)&&(t[this.fbIndex]=o[this.palIndex+n],this.tpri=3840&this.tpri|u,c[this.fbIndex]=this.tpri)),this.fbIndex++,this.tIndex++;this.fbIndex-=8,this.fbIndex+=256,this.tIndex-=16}else for(this.fbIndex=(a<<8)+h,this.tIndex=63,this.y=0;this.y<8;this.y++){for(this.x=0;this.x<8;this.x++)this.x>=i&&this.x<s&&this.y>=e&&this.y<r&&(this.palIndex=this.pix[this.tIndex],this.tpri=c[this.fbIndex],0!==this.palIndex&&u<=(255&this.tpri)&&(t[this.fbIndex]=o[this.palIndex+n],this.tpri=3840&this.tpri|u,c[this.fbIndex]=this.tpri)),this.fbIndex++,this.tIndex--;this.fbIndex-=8,this.fbIndex+=256}else for(this.fbIndex=(a<<8)+h,this.tIndex=0,this.y=0;this.y<8;this.y+=1){for(this.x=0;this.x<8;this.x+=1)this.x>=i&&this.x<s&&this.y>=e&&this.y<r&&(this.palIndex=this.pix[this.tIndex],this.tpri=c[this.fbIndex],0!==this.palIndex&&u<=(255&this.tpri)&&(t[this.fbIndex]=o[this.palIndex+n],this.tpri=3840&this.tpri|u,c[this.fbIndex]=this.tpri)),this.fbIndex+=1,this.tIndex+=1;this.fbIndex-=8,this.fbIndex+=256}},t.prototype.isTransparent=function(t,i){return 0===this.pix[(i<<3)+t]},t.serializable=["opaque","pix"],t}();!function(t){t[t.vertical=0]="vertical",t[t.horizontal=1]="horizontal",t[t.fourScreen=2]="fourScreen",t[t.singleScreen=3]="singleScreen",t[t.singleScreen2=4]="singleScreen2",t[t.singleScreen3=5]="singleScreen3",t[t.singleScreen4=6]="singleScreen4",t[t.chrRom=7]="chrRom"}(I||(I={}));var D=function(){function t(t){var i,e,s,r=new Uint8Array(t,0,t.byteLength);if(r.length<4||78!==r[0]||69!==r[1]||83!==r[2]||26!==r[3])throw new Error("Not a valid NES rom.");for(this.header=new Array(16),i=0;i<16;i+=1)this.header[i]=255&r[i];if(this.romCount=this.header[4],this.romCount<1)throw new Error("No rom in this bank.");this.vromCount=2*this.header[5],this.mirroring=0!=(1&this.header[6])?1:0,this.batteryRam=0!=(2&this.header[6]),this.trainer=0!=(4&this.header[6]),this.fourScreen=0!=(8&this.header[6]),this.mapperType=this.header[6]>>4|240&this.header[7];var h=!1;for(i=8;i<16;i+=1)if(0!==this.header[i]){h=!0;break}h&&(this.mapperType&=15),this.rom=new Array(this.romCount);var a=16;for(i=0;i<this.romCount;i+=1){for(this.rom[i]=new Array(16384),e=0;e<16384&&!(a+e>=r.length);e+=1)this.rom[i][e]=r[a+e];a+=16384}for(this.vrom=new Array(this.vromCount),i=0;i<this.vromCount;i+=1){for(this.vrom[i]=new Array(4096),e=0;e<4096&&!(a+e>=r.length);e+=1)this.vrom[i][e]=r[a+e];a+=4096}for(this.vromTile=new Array(this.vromCount),i=0;i<this.vromCount;i+=1)for(this.vromTile[i]=new Array(256),e=0;e<256;e+=1)this.vromTile[i][e]=new B;var n,o;for(s=0;s<this.vromCount;s+=1)for(i=0;i<4096;i+=1)n=i>>4,o=i%16,o<8?this.vromTile[s][n].setScanline(o,this.vrom[s][i],this.vrom[s][i+8]):this.vromTile[s][n].setScanline(o-8,this.vrom[s][i-8],this.vrom[s][i])}return Object.defineProperty(t.prototype,"mirroringType",{get:function(){return this.fourScreen?I.fourScreen:0===this.mirroring?I.horizontal:I.vertical},enumerable:!0,configurable:!0}),t}(),w=function(){function t(t,i,e){var s=this;this.onsample=i,this.onerror=e,this.videoBuffer=new Array(61440),this.audioBuffer=[],this.cpu=new b(null),this.ppu=new F(this.cpu,function(t){for(var i=0;i<61440;i+=1)s.videoBuffer[i]=t[i]}),this.apu=new n(this.cpu,function(t){s.audioBuffer.push(t),s.onsample&&s.onsample(t)}),this.controller=new R,this.cpu.mapper=y.create(this.cpu,this.ppu,this.apu,this.controller,t),this.ppu.setMirroring(t.mirroringType)}return t.romSupported=function(t){return y.romSupported(t)},t.prototype.buttonDown=function(t,i){this.controller.buttonDown(t,i)},t.prototype.buttonUp=function(t,i){this.controller.buttonUp(t,i)},t.prototype.frame=function(){this.controller.frame(),this.ppu.startFrame();var t=0,i=this.cpu,e=this.ppu,s=this.apu;t:for(;;){if(0===i.cyclesToHalt){try{t=i.emulate()}catch(t){return this.onerror&&this.onerror(t),!1}s.clockFrameCounter(t),t*=3}else i.cyclesToHalt>8?(t=24,s.clockFrameCounter(8),i.cyclesToHalt-=8):(t=3*i.cyclesToHalt,s.clockFrameCounter(i.cyclesToHalt),i.cyclesToHalt=0);for(;t>0;t-=1){if(e.curX===e.spr0HitX&&1===e.f_spVisibility&&e.scanline-21===e.spr0HitY&&e.setStatusFlag(P.SPRITE0HIT,!0),e.requestEndFrame&&(e.nmiCounter-=1,0===e.nmiCounter)){e.requestEndFrame=!1,e.startVBlank();break t}e.curX+=1,341===e.curX&&(e.curX=0,e.endScanline())}}return!0},t.prototype.pull=function(){var t=this.audioBuffer;return this.audioBuffer=[],{video:this.videoBuffer,audio:t}},t}()});